<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Secretly üí≠</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://hiddencrushbot.com">
    <meta property="og:title" content="Ask Secretly üí≠ - Anonim Soru Sor">
    <meta property="og:description" content="Bana anonim soru sor! Kimliƒüin gizli kalacak üîí">
    <meta property="og:image" content="https://i.imgur.com/vfKAzjc.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://hiddencrushbot.com">
    <meta property="twitter:title" content="Ask Secretly üí≠ - Anonim Soru Sor">
    <meta property="twitter:description" content="Bana anonim soru sor! Kimliƒüin gizli kalacak üîí">
    <meta property="twitter:image" content="https://i.imgur.com/vfKAzjc.png">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí≠</text></svg>">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Tema Deƒüi≈ükenleri */
        :root {
            --primary: #dc2626;
            --primary-hover: #b91c1c;
            --bg: #000;
            --bg-secondary: #16181c;
            --bg-tertiary: #1d1f23;
            --text: #e7e9ea;
            --text-secondary: #71767b;
            --border: #2f3336;
        }
        
        [data-theme="blue"] { --primary: #1d9bf0; --primary-hover: #1a8cd8; }
        
        [data-mode="light"] {
            --bg: #ffffff;
            --bg-secondary: #f7f9f9;
            --bg-tertiary: #eff3f4;
            --text: #0f1419;
            --text-secondary: #536471;
            --border: #eff3f4;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Header */
        .header {
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); }
        .header-actions { display: flex; gap: 8px; align-items: center; }
        .icon-btn {
            background: none;
            border: none;
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: var(--bg-tertiary); }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { background: var(--primary-hover); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-outline:hover { background: var(--bg-tertiary); }
        .btn-twitter { background: #1d9bf0; }
        .btn-twitter:hover { background: #1a8cd8; }
        .btn-full { width: 100%; }
        .btn-sm { padding: 8px 16px; font-size: 14px; }

        /* Auth Page */
        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .auth-card h1 { font-size: 28px; margin-bottom: 8px; }
        .auth-card p { color: var(--text-secondary); margin-bottom: 30px; }
        .auth-card .logo-big { font-size: 48px; margin-bottom: 20px; }
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--text-secondary);
            font-size: 13px;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        .divider span { padding: 0 15px; }

        /* Ask Page */
        .ask-page {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            padding-top: 40px;
        }
        
        .ask-page .container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            overflow: hidden;
        }
        
        .ask-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
        }
        
        textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            color: var(--text);
            font-size: 16px;
            resize: none;
            min-height: 120px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        textarea:focus { outline: none; border-color: var(--primary); }
        textarea::placeholder { color: var(--text-secondary); }
        .char-count { text-align: right; color: var(--text-secondary); font-size: 13px; margin-top: 8px; }
        .anonymous-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-tertiary);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 16px;
        }

        /* Profile Page - Twitter Style */
        .profile-banner {
            height: 200px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .profile-banner-edit {
            position: absolute;
            top: 12px;
            right: 12px;
        }
        
        .banner-upload-btn {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .banner-upload-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .profile-info {
            padding: 16px;
            margin-top: -80px;
            position: relative;
        }
        
        .profile-avatar-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 16px;
        }
        
        .profile-avatar {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 5px solid var(--bg);
            object-fit: cover;
        }
        
        .avatar-placeholder {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 5px solid var(--bg);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 56px;
            font-weight: 700;
            color: #fff;
        }
        
        .edit-avatar {
            position: absolute;
            bottom: 8px;
            right: 8px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--bg);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
        }
        .edit-avatar:hover { background: var(--bg-tertiary); }
        
        .profile-actions {
            position: absolute;
            top: 16px;
            right: 16px;
        }
        
        .profile-name {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 2px;
        }
        
        .profile-handle {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 12px;
        }
        
        .profile-bio {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .profile-meta {
            display: flex;
            gap: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .profile-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 12px;
        }
        
        .stat {
            display: flex;
            gap: 4px;
            font-size: 14px;
        }
        
        .stat strong {
            font-weight: 700;
            color: var(--text);
        }
        
        .stat span {
            color: var(--text-secondary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }
        .tab {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 16px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            position: relative;
            transition: background 0.2s;
        }
        .tab:hover { background: var(--bg-tertiary); }
        .tab.active { color: var(--text); }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* Question Cards */
        .question-card {
            border-bottom: 1px solid var(--border);
            padding: 16px;
            transition: background 0.2s;
            cursor: pointer;
        }
        .question-card:hover { background: var(--bg-secondary); }
        .question-card.my-question { background: var(--bg-secondary); }
        
        .question-header {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .question-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .question-main {
            flex: 1;
            min-width: 0;
        }
        
        .question-author {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .question-author-name {
            font-weight: 700;
            font-size: 15px;
        }
        
        .question-author-handle {
            color: var(--text-secondary);
            font-size: 15px;
        }
        
        .question-time {
            color: var(--text-secondary);
            font-size: 15px;
        }
        
        .question-content {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 12px;
            word-wrap: break-word;
        }
        
        .answer-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        .answer-label {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .answer-text {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 12px;
        }
        
        .answer-input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            color: var(--text);
            font-size: 15px;
            resize: none;
            min-height: 80px;
            margin-top: 8px;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        .answer-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .question-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            gap: 8px;
        }
        
        .action-group {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            padding: 6px 14px;
            border-radius: 20px;
            transition: all 0.2s;
            font-weight: 600;
        }
        .action-btn:hover { 
            background: var(--bg-tertiary); 
            border-color: var(--primary);
            color: var(--primary); 
        }
        .action-btn.delete:hover { 
            color: #f4212e; 
            border-color: #f4212e;
        }
        .action-btn.answer {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }
        .action-btn.answer:hover {
            background: var(--primary-hover);
        }

        /* Share Modal */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .share-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .share-header h3 {
            font-size: 20px;
            font-weight: 800;
        }
        .share-close {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .share-close:hover {
            background: var(--bg-tertiary);
        }
        .share-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .share-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .share-option:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }
        .share-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .share-option-info {
            flex: 1;
        }
        .share-option-title {
            font-weight: 700;
            font-size: 15px;
        }
        .share-option-desc {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Link Box */
        .link-box {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .link-box label {
            font-size: 13px;
            font-weight: 700;
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .link-input-group {
            display: flex;
            gap: 8px;
        }
        
        .link-input-group input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text);
            font-size: 14px;
        }
        .link-input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .modal-header h2 { font-size: 18px; font-weight: 700; }
        .modal-body { padding: 16px; }
        .setting-group {
            margin-bottom: 24px;
        }
        .setting-group label {
            font-size: 14px;
            font-weight: 600;
            display: block;
            margin-bottom: 12px;
            color: var(--text-secondary);
        }
        .theme-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .theme-option {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .theme-option:hover { transform: scale(1.1); }
        .theme-option.active { border-color: var(--text); }
        .theme-option.red { background: #dc2626; }
        .theme-option.blue { background: #1d9bf0; }
        .mode-options {
            display: flex;
            gap: 10px;
        }
        .mode-option {
            flex: 1;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid var(--border);
            cursor: pointer;
            text-align: center;
            transition: border-color 0.2s;
        }
        .mode-option:hover { border-color: var(--text-secondary); }
        .mode-option.active { border-color: var(--primary); }
        .mode-option .icon { font-size: 24px; margin-bottom: 8px; }
        .mode-option .label { font-size: 14px; font-weight: 600; }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: #fff;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1001;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text); }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        
        /* Responsive */
        @media (max-width: 480px) {
            .auth-card { padding: 24px; }
            .profile-banner { height: 140px; }
            .profile-avatar, .avatar-placeholder { width: 90px; height: 90px; font-size: 36px; }
            .profile-info { margin-top: -45px; }
            .profile-actions { top: 50px; }
            .action-group { flex-wrap: wrap; }
        }
    </style>
</head>
<body data-theme="red" data-mode="dark">
    <div id="notification" class="notification hidden"></div>

    <!-- Share Modal -->
    <div id="shareModal" class="share-modal hidden" onclick="closeShareModal(event)">
        <div class="share-content" onclick="event.stopPropagation()">
            <div class="share-header">
                <h3>üí≠ Cevabƒ± Payla≈ü</h3>
                <button class="share-close" onclick="closeShareModal()">‚úï</button>
            </div>
            <div class="share-options">
                <div class="share-option" onclick="shareToTwitterFromModal()">
                    <div class="share-icon" style="background: #1d9bf0; color: #fff;">üê¶</div>
                    <div class="share-option-info">
                        <div class="share-option-title">Twitter'da Payla≈ü</div>
                        <div class="share-option-desc">Tweet olarak payla≈ü</div>
                    </div>
                </div>
                <div class="share-option" onclick="downloadAsImageFromModal()">
                    <div class="share-icon" style="background: linear-gradient(45deg, #f09433, #dc2743); color: #fff;">üì∏</div>
                    <div class="share-option-info">
                        <div class="share-option-title">G√∂rsel ƒ∞ndir</div>
                        <div class="share-option-desc">Instagram story/post i√ßin</div>
                    </div>
                </div>
                <div class="share-option" onclick="copyAnswerLink()">
                    <div class="share-icon" style="background: var(--bg-tertiary); color: var(--primary);">üîó</div>
                    <div class="share-option-info">
                        <div class="share-option-title">Link Kopyala</div>
                        <div class="share-option-desc">Soru linkini kopyala</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden" onclick="closeSettings(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <button class="icon-btn" onclick="hideSettings()">‚úï</button>
                <h2>Ayarlar</h2>
            </div>
            <div class="modal-body">
                <div class="setting-group">
                    <label>Profil D√ºzenle</label>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div>
                            <label style="font-size: 13px; color: var(--text-secondary); display: block; margin-bottom: 6px;">G√∂r√ºnen Ad</label>
                            <input type="text" id="editDisplayName" placeholder="Adƒ±nƒ±z" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 14px;">
                        </div>
                        <div>
                            <label style="font-size: 13px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Bio (A√ßƒ±klama)</label>
                            <textarea id="editBio" placeholder="Bana anonim soru sor! üí≠" maxlength="150" style="width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 14px; min-height: 80px; resize: vertical; font-family: inherit;"></textarea>
                            <div style="text-align: right; font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                <span id="bioCharCount">0</span>/150
                            </div>
                        </div>
                        <button class="btn btn-sm" onclick="saveProfile()">Kaydet</button>
                    </div>
                </div>

                <div class="setting-group">
                    <label>Tema Rengi</label>
                    <div class="theme-options">
                        <div class="theme-option red active" onclick="setTheme('red')"></div>
                        <div class="theme-option blue" onclick="setTheme('blue')"></div>
                    </div>
                </div>
                <div class="setting-group">
                    <label>G√∂r√ºn√ºm</label>
                    <div class="mode-options">
                        <div class="mode-option active" onclick="setMode('dark')">
                            <div class="icon">üåô</div>
                            <div class="label">Koyu</div>
                        </div>
                        <div class="mode-option" onclick="setMode('light')">
                            <div class="icon">‚òÄÔ∏è</div>
                            <div class="label">A√ßƒ±k</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-outline btn-full" onclick="logout()" style="margin-top: 20px;">
                    üö™ √áƒ±kƒ±≈ü Yap
                </button>
            </div>
        </div>
    </div>

<!-- PART 2 BA≈ûLANGI√á - Part 1'den sonra yapƒ±≈ütƒ±rƒ±n -->

    <!-- Landing Page -->
    <div id="landingPage" class="auth-page">
        <div class="auth-card">
            <div class="logo-big">üí≠</div>
            <h1>Ask Secretly</h1>
            <p>Anonim sorular al, dilediƒüin gibi cevapla!</p>
            <button class="btn btn-twitter btn-full" onclick="loginWithTwitter()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                Twitter ile Giri≈ü Yap
            </button>
            <div class="divider"><span>veya</span></div>
            <button class="btn btn-outline btn-full" onclick="showEmailLogin()">
                E-posta ile Giri≈ü
            </button>
        </div>
    </div>

    <!-- Email Login Page -->
    <div id="emailLoginPage" class="auth-page hidden">
        <div class="auth-card">
            <h1>Giri≈ü Yap</h1>
            <p>E-posta ve ≈üifrenle giri≈ü yap</p>
            <div style="text-align: left;">
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">E-posta</label>
                <input type="email" id="loginEmail" placeholder="ornek@email.com" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 16px;">
                
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">≈ûifre</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 20px;">
            </div>
            <button class="btn btn-full" onclick="handleEmailLogin()">Giri≈ü Yap</button>
            <div class="divider"><span>veya</span></div>
            <button class="btn btn-outline btn-full" onclick="showEmailSignup()">Hesap Olu≈ütur</button>
            <p style="margin-top: 20px; font-size: 14px; color: var(--text-secondary);">
                <a onclick="showLanding()" style="color: var(--primary); cursor: pointer;">‚Üê Geri D√∂n</a>
            </p>
        </div>
    </div>

    <!-- Email Signup Page -->
    <div id="emailSignupPage" class="auth-page hidden">
        <div class="auth-card">
            <h1>Hesap Olu≈ütur</h1>
            <p>Yeni hesap olu≈ütur</p>
            <div style="text-align: left;">
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="signupUsername" placeholder="kullaniciadi" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 16px;">
                
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">E-posta</label>
                <input type="email" id="signupEmail" placeholder="ornek@email.com" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 16px;">
                
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">≈ûifre</label>
                <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 20px;">
            </div>
            <button class="btn btn-full" onclick="handleEmailSignup()">Hesap Olu≈ütur</button>
            <p style="margin-top: 20px; font-size: 14px; color: var(--text-secondary);">
                <a onclick="showEmailLogin()" style="color: var(--primary); cursor: pointer;">‚Üê Giri≈ü Yap</a>
            </p>
        </div>
    </div>

    <!-- Public Profile Page -->
    <div id="askPage" class="ask-page hidden">
        <div class="container" style="max-width: 600px;">
            <div class="profile-banner" id="publicProfileBanner" style="height: 150px; border-radius: 16px 16px 0 0;"></div>
            
            <div style="padding: 0 20px;">
                <div style="margin-top: -40px; margin-bottom: 16px; position: relative;">
                    <img id="publicAvatar" src="" alt="" style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--bg); background: var(--bg-secondary);">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h2 id="publicDisplayName" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">Kullanƒ±cƒ±</h2>
                    <p id="publicHandle" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px;">@kullanici</p>
                    <p id="publicBio" style="font-size: 15px; color: var(--text); margin-bottom: 16px;">Bana anonim soru sor! üí≠</p>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="font-size: 14px;">
                            <strong id="publicQuestionCount" style="color: var(--text);">0</strong>
                            <span style="color: var(--text-secondary);"> Soru</span>
                        </div>
                        <div style="font-size: 14px;">
                            <strong id="publicAnsweredCount" style="color: var(--text);">0</strong>
                            <span style="color: var(--text-secondary);"> Cevaplanan</span>
                        </div>
                    </div>
                </div>
                
                <!-- Ask Question Card -->
                <div class="ask-card" style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">üí≠ Anonim Soru Sor</h3>
                    <textarea id="questionInput" placeholder="Anonim sorunuzu yazƒ±n..." maxlength="500" style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-size: 15px; resize: vertical; font-family: inherit;"></textarea>
                    <div class="char-count" style="text-align: right; margin-top: 8px; margin-bottom: 12px;"><span id="charCount">0</span>/500</div>
                    <button class="btn btn-full" id="sendBtn" onclick="sendQuestion()">
                        G√∂nder
                    </button>
                    <div class="anonymous-badge" style="margin-top: 12px; text-align: center; color: var(--text-secondary); font-size: 13px;">
                        üîí Kimliƒüin gizli kalacak
                    </div>
                </div>
                
                <!-- Answered Questions Feed -->
                <div>
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">Cevaplanan Sorular</h3>
                    <div id="publicFeedContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="hidden">
        <div class="header">
            <div class="logo">Ask Secretly</div>
            <div class="header-actions">
                <button class="icon-btn" onclick="showSettings()">‚öôÔ∏è</button>
                <button class="icon-btn" onclick="logout()">üö™</button>
            </div>
        </div>
        
        <div class="container">
            <!-- Profile Header - Twitter Style -->
            <div class="profile-banner" id="profileBanner">
                <div class="profile-banner-edit">
                    <label class="banner-upload-btn">
                        üì∑ Banner Deƒüi≈ütir
                        <input type="file" id="bannerInput" accept="image/*" style="display:none;" onchange="uploadBanner(event)">
                    </label>
                </div>
            </div>
            
            <div class="profile-info">
                <div class="profile-avatar-wrapper">
                    <img id="profileAvatar" class="profile-avatar hidden" src="" alt="">
                    <div id="profileAvatarPlaceholder" class="avatar-placeholder">U</div>
                    <label class="edit-avatar" for="avatarInput">üì∑</label>
                    <input type="file" id="avatarInput" accept="image/*" style="display:none;" onchange="uploadAvatar(event)">
                </div>
                
                <div class="profile-name" id="profileName">Kullanƒ±cƒ±</div>
                <div class="profile-handle" id="profileHandle">@kullanici</div>
                
                <div class="profile-bio" id="profileBio">
                    Bana anonim soru sor! üí≠
                </div>
                
                <div class="profile-meta">
                    <div class="profile-meta-item">
                        üìç Ask Secretly
                    </div>
                    <div class="profile-meta-item">
                        üóìÔ∏è <span id="joinDate">2024'te katƒ±ldƒ±</span>
                    </div>
                </div>
                
                <div class="profile-stats">
                    <div class="stat">
                        <strong id="questionsCount">0</strong>
                        <span>Soru</span>
                    </div>
                    <div class="stat">
                        <strong id="answeredQuestionsCount">0</strong>
                        <span>Cevaplanan</span>
                    </div>
                </div>
            </div>

            <!-- Link Box -->
            <div class="link-box">
                <label>üí≠ SORU Lƒ∞NKƒ∞N</label>
                <div class="link-input-group">
                    <input type="text" id="profileLink" readonly>
                    <button class="btn btn-sm" onclick="copyLink()">Kopyala</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="inbox" onclick="switchTab('inbox')">
                    Gelen (<span id="inboxCount">0</span>)
                </button>
                <button class="tab" data-tab="answered" onclick="switchTab('answered')">
                    Cevaplanan (<span id="answeredCount">0</span>)
                </button>
            </div>

            <!-- Feed -->
            <div id="feedContainer"></div>
        </div>
    </div>

<script>
// ============================================
// ASK SECRETLY - FULL VERSION
// ============================================

let auth, db, storage;
let currentUser = null;
let currentUserData = null;
let currentTab = 'inbox';
let currentShareQuestion = null;
let isUploadingAvatar = false;
let isUploadingBanner = false;
let charCounterAttached = false;
let oneSignalReady = false;

// ============================================
// FIREBASE INIT
// ============================================
async function initFirebase() {
    try {
        const configResponse = await fetch('/api/get-firebase-config');
        if (!configResponse.ok) {
            throw new Error('Firebase config alƒ±namadƒ±');
        }
        const _c = await configResponse.json();
        firebase.initializeApp(_c);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        
        onAppReady();
    } catch (error) {
        console.error('Firebase init error:', error);
        showNotification('Baƒülantƒ± hatasƒ±! Sayfayƒ± yenileyin.');
    }
}

// ============================================
// THEME & MODE
// ============================================
const savedTheme = localStorage.getItem('theme') || 'red';
const savedMode = localStorage.getItem('mode') || 'dark';
document.body.setAttribute('data-theme', savedTheme);
document.body.setAttribute('data-mode', savedMode);

function setTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    document.querySelectorAll('.theme-option').forEach(el => el.classList.remove('active'));
    document.querySelector(`.theme-option.${theme}`)?.classList.add('active');
}

function setMode(mode) {
    document.body.setAttribute('data-mode', mode);
    localStorage.setItem('mode', mode);
    document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
    event.target.closest('.mode-option')?.classList.add('active');
}

function onAppReady() {
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('u');

    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
        } catch (e) {
            localStorage.removeItem('currentUser');
        }
    }

    if (username) {
        loadAskPage(username);
    } else if (currentUser) {
        loadDashboard();
    } else {
        showLanding();
    }

    document.querySelector(`.theme-option.${savedTheme}`)?.classList.add('active');
}

initFirebase();

// ============================================
// NOTIFICATIONS
// ============================================
function showNotification(msg) {
    const notif = document.getElementById('notification');
    notif.textContent = msg;
    notif.classList.remove('hidden');
    setTimeout(() => notif.classList.add('hidden'), 3000);
}

// ============================================
// PAGE NAVIGATION
// ============================================
function showPage(pageId) {
    ['landingPage', 'emailLoginPage', 'emailSignupPage', 'askPage', 'dashboardPage'].forEach(id => {
        document.getElementById(id)?.classList.add('hidden');
    });
    document.getElementById(pageId)?.classList.remove('hidden');
}

function showLanding() { showPage('landingPage'); }
function showEmailLogin() { showPage('emailLoginPage'); }
function showEmailSignup() { showPage('emailSignupPage'); }

function showSettings() { 
    document.getElementById('settingsModal').classList.remove('hidden');
    if (currentUserData) {
        document.getElementById('editDisplayName').value = currentUserData.displayName || currentUserData.username || '';
        document.getElementById('editBio').value = currentUserData.bio || 'Bana anonim soru sor! üí≠';
        updateBioCharCount();
    }
}

function updateBioCharCount() {
    const bioTextarea = document.getElementById('editBio');
    const charCount = document.getElementById('bioCharCount');
    if (bioTextarea && charCount) {
        charCount.textContent = bioTextarea.value.length;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const bioTextarea = document.getElementById('editBio');
    if (bioTextarea) {
        bioTextarea.addEventListener('input', updateBioCharCount);
    }
});

function hideSettings() { document.getElementById('settingsModal').classList.add('hidden'); }
function closeSettings(e) { if (e.target === e.currentTarget) hideSettings(); }

// ============================================
// SHARE MODAL
// ============================================
function openShareModal(questionId, question, answer) {
    currentShareQuestion = { id: questionId, question: question, answer: answer };
    document.getElementById('shareModal').classList.remove('hidden');
}

function closeShareModal(e) {
    if (!e || e.target === e.currentTarget) {
        document.getElementById('shareModal').classList.add('hidden');
        currentShareQuestion = null;
    }
}

function shareToTwitterFromModal() {
    if (!currentShareQuestion) return;
    const { question, answer } = currentShareQuestion;
    const text = `üí≠ Soru: "${question}"

üó£Ô∏è Cevap: "${answer}"

Bana anonim soru sor üëá
${window.location.origin}${window.location.pathname}?u=${currentUserData.username}`;

    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
    window.open(twitterUrl, '_blank');
    closeShareModal();
}

async function downloadAsImageFromModal() {
    if (!currentShareQuestion) return;
    await downloadAsImage(currentShareQuestion.id);
    closeShareModal();
}

function copyAnswerLink() {
    const link = `${window.location.origin}${window.location.pathname}?u=${currentUserData.username}`;
    navigator.clipboard.writeText(link).then(() => {
        showNotification('Link kopyalandƒ±! üîó');
        closeShareModal();
    }).catch(() => {
        showNotification('Kopyalama ba≈üarƒ±sƒ±z!');
    });
}

// ============================================
// ANONIM ID SYSTEM
// ============================================
function getOrCreateAnonId() {
    let anonId = localStorage.getItem('ask_secretly_anon_id');
    
    if (!anonId) {
        anonId = 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('ask_secretly_anon_id', anonId);
        console.log('Yeni anonim ID:', anonId);
    }
    
    return anonId;
}

// ============================================
// TWITTER LOGIN
// ============================================
async function loginWithTwitter() {
    try {
        const provider = new firebase.auth.TwitterAuthProvider();
        const result = await auth.signInWithPopup(provider);
        await handleAuthSuccess(result.user, result.additionalUserInfo);
    } catch (error) {
        console.error('Twitter login error:', error);
        if (error.code === 'auth/popup-closed-by-user') {
            showNotification('Giri≈ü iptal edildi');
        } else {
            showNotification('Giri≈ü ba≈üarƒ±sƒ±z: ' + error.message);
        }
    }
}

// ============================================
// EMAIL LOGIN/SIGNUP
// ============================================
async function handleEmailLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!email || !password) {
        showNotification('T√ºm alanlarƒ± doldur!');
        return;
    }

    try {
        const result = await auth.signInWithEmailAndPassword(email, password);
        const user = result.user;
        
        const userQuery = await db.collection('users').where('email', '==', email).get();
        if (!userQuery.empty) {
            const userDoc = userQuery.docs[0];
            currentUser = { uid: userDoc.id };
            currentUserData = userDoc.data();
            localStorage.setItem('currentUser', JSON.stringify({ uid: userDoc.id }));
            showNotification('Ho≈ü geldin! üí≠');
            loadDashboard();
        } else {
            showNotification('Kullanƒ±cƒ± profili bulunamadƒ±!');
        }
    } catch (error) {
        console.error('Login error:', error);
        if (error.code === 'auth/user-not-found') {
            showNotification('Bu e-posta kayƒ±tlƒ± deƒüil!');
        } else if (error.code === 'auth/wrong-password') {
            showNotification('≈ûifre hatalƒ±!');
        } else if (error.code === 'auth/invalid-email') {
            showNotification('Ge√ßersiz e-posta!');
        } else {
            showNotification('Giri≈ü ba≈üarƒ±sƒ±z: ' + error.message);
        }
    }
}

async function handleEmailSignup() {
    const username = document.getElementById('signupUsername').value.toLowerCase().trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;

    if (username.length < 3) {
        showNotification('Kullanƒ±cƒ± adƒ± en az 3 karakter olmalƒ±!');
        return;
    }
    if (!email) {
        showNotification('E-posta gerekli!');
        return;
    }
    if (password.length < 6) {
        showNotification('≈ûifre en az 6 karakter olmalƒ±!');
        return;
    }

    const safeUsername = username
        .replace(/≈ü/g, 's').replace(/ƒ±/g, 'i').replace(/ƒü/g, 'g')
        .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
        .replace(/[^a-z0-9]/g, '');

    if (safeUsername.length < 3) {
        showNotification('Ge√ßerli bir kullanƒ±cƒ± adƒ± gir!');
        return;
    }

    try {
        const userDoc = await db.collection('users').doc(safeUsername).get();
        if (userDoc.exists) {
            showNotification('Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü!');
            return;
        }

        const result = await auth.createUserWithEmailAndPassword(email, password);
        const user = result.user;

        await db.collection('users').doc(safeUsername).set({
            username: safeUsername,
            displayName: username,
            email: email,
            firebaseUid: user.uid,
            photoURL: null,
            bannerURL: null,
            bio: 'Bana anonim soru sor! üí≠',
            followers: [],
            following: [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        currentUser = { uid: safeUsername };
        currentUserData = { username: safeUsername, displayName: username, email: email, bio: 'Bana anonim soru sor! üí≠' };
        localStorage.setItem('currentUser', JSON.stringify({ uid: safeUsername }));
        showNotification('Hesap olu≈üturuldu! üéâ');
        loadDashboard();
    } catch (error) {
        console.error('Signup error:', error);
        if (error.code === 'auth/email-already-in-use') {
            showNotification('Bu e-posta zaten kayƒ±tlƒ±!');
        } else if (error.code === 'auth/weak-password') {
            showNotification('≈ûifre √ßok zayƒ±f!');
        } else if (error.code === 'auth/invalid-email') {
            showNotification('Ge√ßersiz e-posta!');
        } else {
            showNotification('Kayƒ±t ba≈üarƒ±sƒ±z: ' + error.message);
        }
    }
}

async function handleAuthSuccess(user, additionalInfo) {
    const rawName = user.displayName || user.uid;
    const username = rawName
        .toLowerCase()
        .replace(/≈ü/g, 's').replace(/ƒ±/g, 'i').replace(/ƒü/g, 'g')
        .replace(/√º/g, 'u').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
        .replace(/[^a-z0-9]/g, '')
        || 'user' + Date.now();
    
    const userRef = db.collection('users').doc(username);
    const userDoc = await userRef.get();

    if (!userDoc.exists) {
        await userRef.set({
            username: username,
            displayName: user.displayName || username,
            photoURL: user.photoURL?.replace('_normal', '') || null,
            bannerURL: null,
            bio: 'Bana anonim soru sor! üí≠',
            followers: [],
            following: [],
            twitterUid: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    currentUser = { uid: username };
    currentUserData = (await userRef.get()).data();
    localStorage.setItem('currentUser', JSON.stringify({ uid: username }));
    showNotification('Ho≈ü geldin! üí≠');
    loadDashboard();
}

function logout() {
    auth.signOut();
    currentUser = null;
    currentUserData = null;
    localStorage.removeItem('currentUser');
    showNotification('√áƒ±kƒ±≈ü yapƒ±ldƒ±!');
    showLanding();
}

// ============================================
// DASHBOARD
// ============================================
async function loadDashboard() {
    if (!currentUser) {
        showLanding();
        return;
    }

    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    if (!userDoc.exists) {
        logout();
        return;
    }
    currentUserData = userDoc.data();

    document.getElementById('profileName').textContent = currentUserData.displayName || currentUserData.username;
    document.getElementById('profileHandle').textContent = '@' + currentUserData.username;
    document.getElementById('profileBio').textContent = currentUserData.bio || 'Bana anonim soru sor! üí≠';
    
    if (currentUserData.photoURL) {
        document.getElementById('profileAvatar').src = currentUserData.photoURL;
        document.getElementById('profileAvatar').classList.remove('hidden');
        document.getElementById('profileAvatarPlaceholder').classList.add('hidden');
    } else {
        document.getElementById('profileAvatarPlaceholder').textContent = currentUserData.username[0].toUpperCase();
        document.getElementById('profileAvatar').classList.add('hidden');
        document.getElementById('profileAvatarPlaceholder').classList.remove('hidden');
    }

    if (currentUserData.bannerURL) {
        document.getElementById('profileBanner').style.backgroundImage = `url(${currentUserData.bannerURL})`;
    } else {
        document.getElementById('profileBanner').style.backgroundImage = 
            'linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%)';
    }

    if (currentUserData.createdAt) {
        const date = new Date(currentUserData.createdAt.toDate());
        const monthNames = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran",
            "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
        document.getElementById('joinDate').textContent = 
            `${monthNames[date.getMonth()]} ${date.getFullYear()}'te katƒ±ldƒ±`;
    }

    const questionsSnapshot = await db.collection('questions').where('to', '==', currentUser.uid).get();
    let totalQuestions = 0;
    let answeredQuestions = 0;
    
    questionsSnapshot.forEach(doc => {
        totalQuestions++;
        if (doc.data().isAnswered) {
            answeredQuestions++;
        }
    });

    document.getElementById('questionsCount').textContent = totalQuestions;
    document.getElementById('answeredQuestionsCount').textContent = answeredQuestions;

    document.getElementById('profileLink').value = `${window.location.origin}${window.location.pathname}?u=${currentUserData.username}`;

    showPage('dashboardPage');
    switchTab('inbox');
}

// ============================================
// TABS
// ============================================
async function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add('active');

    const container = document.getElementById('feedContainer');
    container.innerHTML = '<div class="loading"><div class="spinner"></div>Y√ºkleniyor...</div>';

    try {
        const snapshot = await db.collection('questions')
            .where('to', '==', currentUser.uid)
            .where('isAnswered', '==', tab === 'answered')
            .orderBy('createdAt', 'desc')
            .get();

        const questions = [];
        snapshot.forEach(doc => questions.push({ id: doc.id, ...doc.data() }));

        const allSnapshot = await db.collection('questions').where('to', '==', currentUser.uid).get();
        let inbox = 0, answered = 0;
        allSnapshot.forEach(doc => doc.data().isAnswered ? answered++ : inbox++);
        document.getElementById('inboxCount').textContent = inbox;
        document.getElementById('answeredCount').textContent = answered;
        document.getElementById('questionsCount').textContent = inbox + answered;

        if (questions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üí≠</div>
                    <h3>${tab === 'inbox' ? 'Hen√ºz soru yok' : 'Hen√ºz cevap yok'}</h3>
                    <p>${tab === 'inbox' ? 'Linkini payla≈ü ve sorular almaya ba≈üla!' : 'Gelen sorularƒ±nƒ± cevapla!'}</p>
                </div>
            `;
            return;
        }

        container.innerHTML = questions.map(q => {
            const date = q.createdAt ? new Date(q.createdAt.toDate()) : new Date();
            const timeAgo = getTimeAgo(date);
            
            return `
                <div class="question-card" id="card-${q.id}" 
                     data-qid="${q.id}"
                     data-question="${escapeHtml(q.question)}"
                     data-answer="${q.answer ? escapeHtml(q.answer) : ''}">
                    <div class="question-header">
                        <div class="question-avatar">‚ùì</div>
                        <div class="question-main">
                            <div class="question-author">
                                <span class="question-author-name">Anonim</span>
                                <span class="question-author-handle">@anonymous</span>
                                <span class="question-time">¬∑ ${timeAgo}</span>
                            </div>
                            <div class="question-content">${escapeHtml(q.question)}</div>
                            ${q.isAnswered ? `
                                <div class="answer-section">
                                    <div class="answer-label">
                                        üí¨ Cevap
                                    </div>
                                    <div class="answer-text">${escapeHtml(q.answer)}</div>
                                </div>
                                <div class="question-actions">
                                    <div class="action-group">
                                        <button class="action-btn" onclick="openShareModalSafe(this)">
                                            üì§ Payla≈ü
                                        </button>
                                    </div>
                                    <button class="action-btn delete" data-qid="${q.id}" onclick="deleteQuestionSafe(this)">üóëÔ∏è</button>
                                </div>
                            ` : `
                                <div class="answer-section">
                                    <textarea class="answer-input" id="answer-${q.id}" placeholder="Cevabƒ±nƒ± yaz..."></textarea>
                                </div>
                                <div class="question-actions">
                                    <button class="action-btn answer" data-qid="${q.id}" onclick="answerQuestionSafe(this)">‚úì Cevapla</button>
                                    <button class="action-btn delete" data-qid="${q.id}" onclick="deleteQuestionSafe(this)">üóëÔ∏è</button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Load questions error:', error);
        container.innerHTML = '<div class="empty-state"><h3>Bir hata olu≈ütu</h3></div>';
    }
}

function openShareModalSafe(button) {
    const card = button.closest('.question-card');
    const id = card.dataset.qid;
    const question = card.dataset.question;
    const answer = card.dataset.answer;
    openShareModal(id, question, answer);
}

function deleteQuestionSafe(button) {
    const qid = button.dataset.qid;
    deleteQuestion(qid);
}

function answerQuestionSafe(button) {
    const qid = button.dataset.qid;
    answerQuestion(qid);
}

function getTimeAgo(date) {
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Az √∂nce';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' dk';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' sa';
    if (seconds < 604800) return Math.floor(seconds / 86400) + ' g√ºn';
    
    return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
}

// ============================================
// PUBLIC PROFILE PAGE
// ============================================
async function loadAskPage(username) {
    try {
        const userDoc = await db.collection('users').doc(username).get();
        if (!userDoc.exists) {
            showNotification('Kullanƒ±cƒ± bulunamadƒ±!');
            showLanding();
            return;
        }

        const viewingUser = userDoc.data();
        
        document.getElementById('publicDisplayName').textContent = viewingUser.displayName || viewingUser.username;
        document.getElementById('publicHandle').textContent = '@' + viewingUser.username;
        document.getElementById('publicBio').textContent = viewingUser.bio || 'Bana anonim soru sor! üí≠';
        
        if (viewingUser.photoURL) {
            document.getElementById('publicAvatar').src = viewingUser.photoURL;
        } else {
            document.getElementById('publicAvatar').src = `https://ui-avatars.com/api/?name=${viewingUser.username}&background=dc2626&color=fff&size=128`;
        }
        
        if (viewingUser.bannerURL) {
            document.getElementById('publicProfileBanner').style.backgroundImage = `url(${viewingUser.bannerURL})`;
        } else {
            document.getElementById('publicProfileBanner').style.backgroundImage = 
                'linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%)';
        }

        const allQuestionsSnapshot = await db.collection('questions').where('to', '==', username).get();
        let totalQuestions = 0;
        let answeredQuestions = 0;
        allQuestionsSnapshot.forEach(doc => {
            totalQuestions++;
            if (doc.data().isAnswered) answeredQuestions++;
        });
        
        document.getElementById('publicQuestionCount').textContent = totalQuestions;
        document.getElementById('publicAnsweredCount').textContent = answeredQuestions;

        await loadPublicQuestions(username);

        document.getElementById('questionInput').value = '';
        document.getElementById('charCount').textContent = '0';
        
        setupCharCounter();
        checkMyAnsweredQuestions();
        
        showPage('askPage');
    } catch (error) {
        console.error('Load ask page error:', error);
        showNotification('Bir hata olu≈ütu!');
    }
}

function setupCharCounter() {
    const input = document.getElementById('questionInput');
    const counter = document.getElementById('charCount');
    
    if (input && counter && !charCounterAttached) {
        input.addEventListener('input', function() {
            counter.textContent = this.value.length;
        });
        charCounterAttached = true;
    }
}

// ============================================
// ‚úÖ LOAD PUBLIC QUESTIONS (D√úZELTƒ∞LMƒ∞≈û)
// ============================================
async function loadPublicQuestions(username) {
    const container = document.getElementById('publicFeedContainer');
    const myAnonId = getOrCreateAnonId();
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <div style="width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px;"></div>
            Cevaplanan sorular y√ºkleniyor...
        </div>
    `;
    
    try {
        // ‚úÖ orderBy kaldƒ±rƒ±ldƒ± - manuel sƒ±ralama yapƒ±lacak
        const snapshot = await db.collection('questions')
            .where('to', '==', username)
            .where('isAnswered', '==', true)
            .limit(50)
            .get();

        const questions = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            questions.push({ 
                id: doc.id, 
                ...data,
                sortDate: data.createdAt || new Date()
            });
        });

        // ‚úÖ Manuel sƒ±ralama (en yeniden eskiye)
        questions.sort((a, b) => {
            const dateA = a.sortDate?.toDate ? a.sortDate.toDate() : new Date(a.sortDate);
            const dateB = b.sortDate?.toDate ? b.sortDate.toDate() : new Date(b.sortDate);
            return dateB - dateA;
        });

        if (questions.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 16px;">üí≠</div>
                    <h3 style="font-size: 18px; margin-bottom: 8px; color: var(--text);">Hen√ºz cevaplanan soru yok</h3>
                    <p style="font-size: 14px;">ƒ∞lk soruyu sen sor!</p>
                </div>
            `;
            return;
        }

        const questionsHTML = questions.map(q => {
            let timeAgo = 'Az √∂nce';
            try {
                if (q.createdAt) {
                    const date = new Date(q.createdAt.toDate());
                    timeAgo = getTimeAgo(date);
                }
            } catch (e) {
                console.log('Date error:', e);
            }
            
            const isMyQuestion = q.anonId === myAnonId;
            
            return `
                <div class="question-card ${isMyQuestion ? 'my-question' : ''}" style="border-bottom: 1px solid var(--border); padding: 16px;">
                    <div style="display: flex; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                            ${isMyQuestion ? 'üôã' : '‚ùì'}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                <span style="font-weight: 700; font-size: 15px;">${isMyQuestion ? 'Sen' : 'Anonim'}</span>
                                <span style="color: var(--text-secondary); font-size: 15px;">@anonymous</span>
                                <span style="color: var(--text-secondary); font-size: 15px;">¬∑ ${timeAgo}</span>
                                ${isMyQuestion ? '<span style="background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700;">SORUN</span>' : ''}
                            </div>
                            
                            <div style="font-size: 15px; line-height: 1.5; margin-bottom: 12px; word-wrap: break-word;">
                                ${escapeHtml(q.question)}
                            </div>
                            
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <div style="color: var(--text-secondary); font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                                    üí¨ Cevap
                                </div>
                                <div style="font-size: 15px; line-height: 1.5; word-wrap: break-word; margin-bottom: 12px;">
                                    ${escapeHtml(q.answer || '')}
                                </div>
                                
                                ${isMyQuestion ? `
                                    <button 
                                        onclick="scrollToQuestionInput()"
                                        style="
                                            background: var(--primary);
                                            color: #fff;
                                            border: none;
                                            padding: 8px 16px;
                                            border-radius: 20px;
                                            font-size: 14px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            display: inline-flex;
                                            align-items: center;
                                            gap: 6px;
                                        "
                                    >
                                        ‚ûï Tekrar Soru Sor
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = questionsHTML;
        
    } catch (error) {
        console.error('Load questions error:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                <h3 style="font-size: 18px; margin-bottom: 8px; color: var(--text);">Sorular y√ºklenemedi</h3>
                <p style="font-size: 14px;">${error.message}</p>
            </div>
        `;
    }
}

// ============================================
// SEND QUESTION
// ============================================
async function sendQuestion() {
    const btn = document.getElementById('sendBtn');
    const text = document.getElementById('questionInput').value.trim();
    
    if (text.length < 3) {
        showNotification('Soru en az 3 karakter olmalƒ±!');
        return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('u');
    const anonId = getOrCreateAnonId();

    btn.disabled = true;
    btn.textContent = 'G√∂nderiliyor...';

    try {
        const questionRef = await db.collection('questions').add({
            to: username,
            question: text,
            answer: null,
            isAnswered: false,
            anonId: anonId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Save to localStorage
        let myQuestions = JSON.parse(localStorage.getItem('my_questions') || '{}');
        myQuestions[questionRef.id] = {
            to: username,
            askedAt: Date.now(),
            isAnswered: false
        };
        localStorage.setItem('my_questions', JSON.stringify(myQuestions));

        // OneSignal notification
        try {
            await fetch('/api/send-onesignal-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, questionText: text })
            });
        } catch (e) {
            console.log('Notification error:', e);
        }

        document.getElementById('questionInput').value = '';
        document.getElementById('charCount').textContent = '0';
        showNotification('Sorun g√∂nderildi! ‚úÖ');
        
        await loadPublicQuestions(username);
        
    } catch (error) {
        console.error('Send question error:', error);
        showNotification('Bir hata olu≈ütu!');
    } finally {
        btn.disabled = false;
        btn.textContent = 'G√∂nder';
    }
}

// ============================================
// CHECK MY ANSWERED QUESTIONS
// ============================================
async function checkMyAnsweredQuestions() {
    const myQuestions = JSON.parse(localStorage.getItem('my_questions') || '{}');
    const questionIds = Object.keys(myQuestions);
    
    if (questionIds.length === 0) return;
    
    let newAnswers = 0;
    
    for (const qid of questionIds) {
        if (myQuestions[qid].isAnswered) continue;
        
        try {
            const doc = await db.collection('questions').doc(qid).get();
            if (doc.exists && doc.data().isAnswered) {
                myQuestions[qid].isAnswered = true;
                newAnswers++;
            }
        } catch (e) {
            console.log('Check error:', e);
        }
    }
    
    localStorage.setItem('my_questions', JSON.stringify(myQuestions));
    
    if (newAnswers > 0) {
        showNotification(`üéâ ${newAnswers} sorunuza cevap geldi!`);
    }
}

// ============================================
// SCROLL TO INPUT
// ============================================
function scrollToQuestionInput() {
    const input = document.getElementById('questionInput');
    if (input) {
        input.focus();
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        showNotification('üí≠ Yeni sorunuzu yazƒ±n!');
    }
}

// ============================================
// ANSWER & DELETE
// ============================================
async function answerQuestion(id) {
    const answer = document.getElementById('answer-' + id).value.trim();
    if (!answer) {
        showNotification('Cevap yazmalƒ±sƒ±n!');
        return;
    }

    try {
        await db.collection('questions').doc(id).update({
            answer: answer,
            isAnswered: true,
            answeredAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showNotification('Cevap kaydedildi! üí¨');
        switchTab(currentTab);
    } catch (error) {
        console.error('Answer error:', error);
        showNotification('Bir hata olu≈ütu: ' + error.message);
    }
}

async function deleteQuestion(id) {
    if (!confirm('Bu soruyu silmek istediƒüine emin misin?')) return;
    try {
        await db.collection('questions').doc(id).delete();
        showNotification('Soru silindi!');
        switchTab(currentTab);
    } catch (error) {
        console.error('Delete error:', error);
        showNotification('Bir hata olu≈ütu: ' + error.message);
    }
}

// ============================================
// UPLOAD AVATAR/BANNER
// ============================================
async function uploadAvatar(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (isUploadingAvatar) {
        showNotification('Zaten y√ºkleniyor, bekle! ‚è≥');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Fotoƒüraf max 5MB olmalƒ±!');
        event.target.value = '';
        return;
    }
    
    isUploadingAvatar = true;
    try {
        showNotification('Y√ºkleniyor...');
        const ref = storage.ref(`avatars/${currentUser.uid}`);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        
        await db.collection('users').doc(currentUser.uid).update({ photoURL: url });
        
        document.getElementById('profileAvatar').src = url;
        document.getElementById('profileAvatar').classList.remove('hidden');
        document.getElementById('profileAvatarPlaceholder').classList.add('hidden');
        
        currentUserData.photoURL = url;
        showNotification('Profil fotoƒürafƒ± g√ºncellendi! üì∏');
    } catch (error) {
        console.error('Upload avatar error:', error);
        showNotification('Y√ºkleme ba≈üarƒ±sƒ±z: ' + error.message);
    } finally {
        isUploadingAvatar = false;
        event.target.value = '';
    }
}

async function uploadBanner(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
        showNotification('Banner max 5MB olmalƒ±!');
        event.target.value = '';
        return;
    }
    
    if (isUploadingBanner) {
        showNotification('Zaten y√ºkleniyor, bekle! ‚è≥');
        return;
    }
    
    isUploadingBanner = true;
    try {
        showNotification('Banner y√ºkleniyor...');
        const ref = storage.ref(`banners/${currentUser.uid}`);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        
        await db.collection('users').doc(currentUser.uid).update({ bannerURL: url });
        
        document.getElementById('profileBanner').style.backgroundImage = `url(${url})`;
        currentUserData.bannerURL = url;
        
        showNotification('Banner g√ºncellendi! üñºÔ∏è');
    } catch (error) {
        console.error('Upload banner error:', error);
        showNotification('Y√ºkleme ba≈üarƒ±sƒ±z: ' + error.message);
    } finally {
        isUploadingBanner = false;
        event.target.value = '';
    }
}

// ============================================
// SAVE PROFILE
// ============================================
async function saveProfile() {
    const newName = document.getElementById('editDisplayName').value.trim();
    const newBio = document.getElementById('editBio').value.trim();
    
    if (!newName) {
        showNotification('ƒ∞sim bo≈ü olamaz!');
        return;
    }
    
    if (newBio.length > 150) {
        showNotification('Bio max 150 karakter!');
        return;
    }

    try {
        await db.collection('users').doc(currentUser.uid).update({ 
            displayName: newName,
            bio: newBio || 'Bana anonim soru sor! üí≠'
        });
        
        document.getElementById('profileName').textContent = newName;
        document.getElementById('profileBio').textContent = newBio || 'Bana anonim soru sor! üí≠';
        
        currentUserData.displayName = newName;
        currentUserData.bio = newBio || 'Bana anonim soru sor! üí≠';
        
        showNotification('Profil g√ºncellendi! ‚úÖ');
        hideSettings();
    } catch (error) {
        console.error('Update profile error:', error);
        showNotification('G√ºncelleme ba≈üarƒ±sƒ±z: ' + error.message);
    }
}

// ============================================
// DOWNLOAD AS IMAGE
// ============================================
async function downloadAsImage(questionId) {
    const card = document.getElementById('card-' + questionId);
    if (!card) {
        showNotification('Kart bulunamadƒ±!');
        return;
    }

    showNotification('G√∂rsel hazƒ±rlanƒ±yor...');

    try {
        const canvas = await html2canvas(card, {
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg').trim(),
            scale: 2,
            useCORS: true,
            logging: false
        });

        const link = document.createElement('a');
        link.download = `ask-secretly-${questionId}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();

        showNotification('G√∂rsel indirildi! üì∑');
    } catch (error) {
        console.error('Download error:', error);
        showNotification('G√∂rsel olu≈üturulamadƒ±: ' + error.message);
    }
}

// ============================================
// UTILS
// ============================================
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function copyLink() {
    const link = document.getElementById('profileLink');
    link.select();
    navigator.clipboard.writeText(link.value).then(() => {
        showNotification('Link kopyalandƒ±! üìã');
    }).catch(() => {
        document.execCommand('copy');
        showNotification('Link kopyalandƒ±! üìã');
    });
}
</script>
</body>
</html>

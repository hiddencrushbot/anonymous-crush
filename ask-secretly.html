<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Secretly üí≠</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://hiddencrushbot.com">
    <meta property="og:title" content="Ask Secretly üí≠ - Anonim Soru Sor">
    <meta property="og:description" content="Bana anonim soru sor! Kimliƒüin gizli kalacak üîí">
    <meta property="og:image" content="https://i.imgur.com/vfKAzjc.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://hiddencrushbot.com">
    <meta property="twitter:title" content="Ask Secretly üí≠ - Anonim Soru Sor">
    <meta property="twitter:description" content="Bana anonim soru sor! Kimliƒüin gizli kalacak üîí">
    <meta property="twitter:image" content="https://i.imgur.com/vfKAzjc.png">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üí≠</text></svg>">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* Tema Deƒüi≈ükenleri */
        :root {
            --primary: #dc2626;
            --primary-hover: #b91c1c;
            --bg: #000;
            --bg-secondary: #16181c;
            --bg-tertiary: #1d1f23;
            --text: #e7e9ea;
            --text-secondary: #71767b;
            --border: #2f3336;
        }
        
        [data-theme="blue"] { --primary: #1d9bf0; --primary-hover: #1a8cd8; }
        [data-theme="green"] { --primary: #00ba7c; --primary-hover: #00a06a; }
        [data-theme="purple"] { --primary: #7856ff; --primary-hover: #6644ee; }
        [data-theme="orange"] { --primary: #ff7a00; --primary-hover: #e66d00; }
        [data-theme="pink"] { --primary: #f91880; --primary-hover: #e01070; }
        
        [data-mode="light"] {
            --bg: #ffffff;
            --bg-secondary: #f7f9f9;
            --bg-tertiary: #eff3f4;
            --text: #0f1419;
            --text-secondary: #536471;
            --border: #eff3f4;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Header */
        .header {
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); }
        .header-actions { display: flex; gap: 8px; align-items: center; }
        .icon-btn {
            background: none;
            border: none;
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: var(--bg-tertiary); }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { background: var(--primary-hover); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-outline:hover { background: var(--bg-tertiary); }
        .btn-twitter { background: #1d9bf0; }
        .btn-twitter:hover { background: #1a8cd8; }
        .btn-full { width: 100%; }
        .btn-sm { padding: 8px 16px; font-size: 14px; }

        /* Auth Page */
        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .auth-card h1 { font-size: 28px; margin-bottom: 8px; }
        .auth-card p { color: var(--text-secondary); margin-bottom: 30px; }
        .auth-card .logo-big { font-size: 48px; margin-bottom: 20px; }
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--text-secondary);
            font-size: 13px;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        .divider span { padding: 0 15px; }

        /* Ask Page */
        .ask-page {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            padding-top: 40px;
        }
        
        .ask-page .container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 100%;
            max-width: 600px;
            overflow: hidden;
        }
        
        .ask-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
        }
        
        textarea {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            color: var(--text);
            font-size: 16px;
            resize: none;
            min-height: 120px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        textarea:focus { outline: none; border-color: var(--primary); }
        textarea::placeholder { color: var(--text-secondary); }
        .char-count { text-align: right; color: var(--text-secondary); font-size: 13px; margin-top: 8px; }
        .anonymous-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-tertiary);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 16px;
        }

        /* Profile Banner */
        .profile-banner {
            height: 150px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
            position: relative;
            background-size: cover;
            background-position: center;
            border-radius: 16px 16px 0 0;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: #fff;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1001;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        
        /* Question Cards */
        .question-card {
            border-bottom: 1px solid var(--border);
            padding: 16px;
            transition: background 0.2s;
        }
        
        .question-card.my-question {
            background: var(--bg-secondary);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .auth-card { padding: 24px; }
        }
    </style>
</head>
<body data-theme="red" data-mode="dark">
    <div id="notification" class="notification hidden"></div>

    <!-- Landing Page -->
    <div id="landingPage" class="auth-page">
        <div class="auth-card">
            <div class="logo-big">üí≠</div>
            <h1>Ask Secretly</h1>
            <p>Anonim sorular al, dilediƒüin gibi cevapla!</p>
            <button class="btn btn-twitter btn-full" onclick="loginWithTwitter()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                Twitter ile Giri≈ü Yap
            </button>
            <div class="divider"><span>veya</span></div>
            <button class="btn btn-outline btn-full" onclick="showEmailLogin()">
                E-posta ile Giri≈ü
            </button>
        </div>
    </div>

    <!-- Email Login Page -->
    <div id="emailLoginPage" class="auth-page hidden">
        <div class="auth-card">
            <h1>Giri≈ü Yap</h1>
            <p>E-posta ve ≈üifrenle giri≈ü yap</p>
            <div style="text-align: left;">
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">E-posta</label>
                <input type="email" id="loginEmail" placeholder="ornek@email.com" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 16px;">
                
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">≈ûifre</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 20px;">
            </div>
            <button class="btn btn-full" onclick="handleEmailLogin()">Giri≈ü Yap</button>
            <div class="divider"><span>veya</span></div>
            <button class="btn btn-outline btn-full" onclick="showEmailSignup()">Hesap Olu≈ütur</button>
            <p style="margin-top: 20px; font-size: 14px; color: var(--text-secondary);">
                <a onclick="showLanding()" style="color: var(--primary); cursor: pointer;">‚Üê Geri D√∂n</a>
            </p>
        </div>
    </div>

    <!-- Email Signup Page -->
    <div id="emailSignupPage" class="auth-page hidden">
        <div class="auth-card">
            <h1>Hesap Olu≈ütur</h1>
            <p>Yeni hesap olu≈ütur</p>
            <div style="text-align: left;">
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="signupUsername" placeholder="kullaniciadi" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 16px;">
                
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">E-posta</label>
                <input type="email" id="signupEmail" placeholder="ornek@email.com" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 16px;">
                
                <label style="display: block; margin-bottom: 6px; font-size: 14px; font-weight: 600;">≈ûifre</label>
                <input type="password" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 15px; margin-bottom: 20px;">
            </div>
            <button class="btn btn-full" onclick="handleEmailSignup()">Hesap Olu≈ütur</button>
            <p style="margin-top: 20px; font-size: 14px; color: var(--text-secondary);">
                <a onclick="showEmailLogin()" style="color: var(--primary); cursor: pointer;">‚Üê Giri≈ü Yap</a>
            </p>
        </div>
    </div>

    <!-- Public Profile Page -->
    <div id="askPage" class="ask-page hidden">
        <div class="container" style="max-width: 600px;">
            <div class="profile-banner" id="publicProfileBanner"></div>
            
            <div style="padding: 0 20px;">
                <div style="margin-top: -40px; margin-bottom: 16px; position: relative;">
                    <img id="publicAvatar" src="" alt="" style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--bg); background: var(--bg-secondary);">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h2 id="publicDisplayName" style="font-size: 22px; font-weight: 700; margin-bottom: 4px;">Kullanƒ±cƒ±</h2>
                    <p id="publicHandle" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 12px;">@kullanici</p>
                    <p id="publicBio" style="font-size: 15px; color: var(--text); margin-bottom: 16px;">Bana anonim soru sor! üí≠</p>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="font-size: 14px;">
                            <strong id="publicQuestionCount" style="color: var(--text);">0</strong>
                            <span style="color: var(--text-secondary);"> Soru</span>
                        </div>
                        <div style="font-size: 14px;">
                            <strong id="publicAnsweredCount" style="color: var(--text);">0</strong>
                            <span style="color: var(--text-secondary);"> Cevaplanan</span>
                        </div>
                    </div>
                </div>
                
                <!-- Ask Question Card -->
                <div class="ask-card" style="margin-bottom: 24px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px;">üí≠ Anonim Soru Sor</h3>
                    <textarea id="questionInput" placeholder="Anonim sorunuzu yazƒ±n..." maxlength="500" style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-size: 15px; resize: vertical; font-family: inherit;"></textarea>
                    <div class="char-count" style="text-align: right; margin-top: 8px; margin-bottom: 12px;"><span id="charCount">0</span>/500</div>
                    <button class="btn btn-full" id="sendBtn" onclick="sendQuestion()">
                        G√∂nder
                    </button>
                    <div class="anonymous-badge" style="margin-top: 12px; text-align: center; color: var(--text-secondary); font-size: 13px;">
                        üîí Kimliƒüin gizli kalacak
                    </div>
                </div>
                
                <!-- Answered Questions Feed -->
                <div>
                    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border);">Cevaplanan Sorular</h3>
                    <div id="publicFeedContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard (simplified for this example) -->
    <div id="dashboardPage" class="hidden">
        <div class="header">
            <div class="logo">Ask Secretly</div>
            <div class="header-actions">
                <button class="icon-btn" onclick="logout()">üö™</button>
            </div>
        </div>
        <div class="container" style="padding: 20px; text-align: center;">
            <h2>Dashboard</h2>
            <p>Dashboard features here...</p>
        </div>
    </div>
<script>
// ============================================
// ASK SECRETLY - PART 2 (JavaScript)
// Firebase + Follow-up Questions + Stats Tracking
// ============================================

// GLOBAL VARIABLES
let auth, db, storage, realtimeDb;
let currentUser = null;
let currentUserData = null;
let oneSignalReady = false;

// ============================================
// FIREBASE INIT
// ============================================
async function initFirebase() {
    try {
        const configResponse = await fetch('/api/get-firebase-config');
        if (!configResponse.ok) {
            throw new Error('Firebase config alƒ±namadƒ±');
        }
        const _c = await configResponse.json();
        firebase.initializeApp(_c);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        realtimeDb = firebase.database(); // ‚úÖ Realtime Database
        
        onAppReady();
    } catch (error) {
        console.error('Firebase init error:', error);
        showNotification('Baƒülantƒ± hatasƒ±! Sayfayƒ± yenileyin.');
    }
}

// ============================================
// THEME & MODE
// ============================================
const savedTheme = localStorage.getItem('theme') || 'red';
const savedMode = localStorage.getItem('mode') || 'dark';
document.body.setAttribute('data-theme', savedTheme);
document.body.setAttribute('data-mode', savedMode);

function onAppReady() {
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('u');

    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
        } catch (e) {
            localStorage.removeItem('currentUser');
        }
    }

    if (username) {
        loadAskPage(username);
    } else if (currentUser) {
        loadDashboard();
    } else {
        showLanding();
    }
}

initFirebase();

// ============================================
// NOTIFICATIONS
// ============================================
function showNotification(msg) {
    const notif = document.getElementById('notification');
    notif.textContent = msg;
    notif.classList.remove('hidden');
    setTimeout(() => notif.classList.add('hidden'), 3000);
}

// ============================================
// PAGE NAVIGATION
// ============================================
function showPage(pageId) {
    ['landingPage', 'emailLoginPage', 'emailSignupPage', 'askPage', 'dashboardPage'].forEach(id => {
        document.getElementById(id)?.classList.add('hidden');
    });
    document.getElementById(pageId)?.classList.remove('hidden');
}

function showLanding() { showPage('landingPage'); }
function showEmailLogin() { showPage('emailLoginPage'); }
function showEmailSignup() { showPage('emailSignupPage'); }

// ============================================
// ‚úÖ ANONIM ID SYSTEM (Follow-up Questions)
// ============================================
function getOrCreateAnonId() {
    let anonId = localStorage.getItem('ask_secretly_anon_id');
    
    if (!anonId) {
        anonId = 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('ask_secretly_anon_id', anonId);
        console.log('Yeni anonim ID:', anonId);
    }
    
    return anonId;
}

// ============================================
// ‚úÖ FIREBASE REALTIME DATABASE TRACKING
// ============================================
function incrementMessageCount() {
    const messagesRef = realtimeDb.ref('stats/totalMessages');
    messagesRef.transaction((current) => {
        return (current || 0) + 1;
    });
}

function trackActiveUser() {
    const sessionId = sessionStorage.getItem('askSecretlySession') || 
                      'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    sessionStorage.setItem('askSecretlySession', sessionId);

    const userRef = realtimeDb.ref('activeUsers/' + sessionId);
    userRef.set({
        lastActive: firebase.database.ServerValue.TIMESTAMP
    });

    // Update count
    realtimeDb.ref('activeUsers').once('value', (snapshot) => {
        const users = snapshot.val() || {};
        const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
        let activeCount = 0;

        Object.keys(users).forEach(userId => {
            if (users[userId].lastActive > thirtyDaysAgo) {
                activeCount++;
            } else {
                realtimeDb.ref('activeUsers/' + userId).remove();
            }
        });

        realtimeDb.ref('stats/activeUsers').set(activeCount);
    });
}

// ============================================
// TWITTER LOGIN
// ============================================
async function loginWithTwitter() {
    try {
        const provider = new firebase.auth.TwitterAuthProvider();
        const result = await auth.signInWithPopup(provider);
        await handleAuthSuccess(result.user, result.additionalUserInfo);
    } catch (error) {
        console.error('Twitter login error:', error);
        showNotification('Giri≈ü ba≈üarƒ±sƒ±z!');
    }
}

// ============================================
// EMAIL LOGIN/SIGNUP
// ============================================
async function handleEmailLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!email || !password) {
        showNotification('T√ºm alanlarƒ± doldur!');
        return;
    }

    try {
        const result = await auth.signInWithEmailAndPassword(email, password);
        const userQuery = await db.collection('users').where('email', '==', email).get();
        if (!userQuery.empty) {
            const userDoc = userQuery.docs[0];
            currentUser = { uid: userDoc.id };
            currentUserData = userDoc.data();
            localStorage.setItem('currentUser', JSON.stringify({ uid: userDoc.id }));
            showNotification('Ho≈ü geldin! üí≠');
            loadDashboard();
        }
    } catch (error) {
        console.error('Login error:', error);
        showNotification('Giri≈ü ba≈üarƒ±sƒ±z!');
    }
}

async function handleEmailSignup() {
    const username = document.getElementById('signupUsername').value.toLowerCase().trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;

    if (username.length < 3 || !email || password.length < 6) {
        showNotification('T√ºm alanlarƒ± doƒüru doldur!');
        return;
    }

    const safeUsername = username.replace(/[^a-z0-9]/g, '');

    try {
        const userDoc = await db.collection('users').doc(safeUsername).get();
        if (userDoc.exists) {
            showNotification('Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü!');
            return;
        }

        const result = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(safeUsername).set({
            username: safeUsername,
            displayName: username,
            email: email,
            firebaseUid: result.user.uid,
            bio: 'Bana anonim soru sor! üí≠',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        currentUser = { uid: safeUsername };
        currentUserData = { username: safeUsername, displayName: username };
        localStorage.setItem('currentUser', JSON.stringify({ uid: safeUsername }));
        showNotification('Hesap olu≈üturuldu! üéâ');
        loadDashboard();
    } catch (error) {
        console.error('Signup error:', error);
        showNotification('Kayƒ±t ba≈üarƒ±sƒ±z!');
    }
}

function logout() {
    auth.signOut();
    currentUser = null;
    localStorage.removeItem('currentUser');
    showNotification('√áƒ±kƒ±≈ü yapƒ±ldƒ±!');
    showLanding();
}

// ============================================
// LOAD PUBLIC PROFILE (ASK PAGE)
// ============================================
async function loadAskPage(username) {
    try {
        const userDoc = await db.collection('users').doc(username).get();
        if (!userDoc.exists) {
            showNotification('Kullanƒ±cƒ± bulunamadƒ±!');
            showLanding();
            return;
        }

        const viewingUser = userDoc.data();
        
        document.getElementById('publicDisplayName').textContent = viewingUser.displayName || viewingUser.username;
        document.getElementById('publicHandle').textContent = '@' + viewingUser.username;
        document.getElementById('publicBio').textContent = viewingUser.bio || 'Bana anonim soru sor! üí≠';
        
        if (viewingUser.photoURL) {
            document.getElementById('publicAvatar').src = viewingUser.photoURL;
        } else {
            document.getElementById('publicAvatar').src = `https://ui-avatars.com/api/?name=${viewingUser.username}&background=dc2626&color=fff&size=128`;
        }
        
        if (viewingUser.bannerURL) {
            document.getElementById('publicProfileBanner').style.backgroundImage = `url(${viewingUser.bannerURL})`;
        }

        const allQuestionsSnapshot = await db.collection('questions').where('to', '==', username).get();
        let totalQuestions = 0;
        let answeredQuestions = 0;
        allQuestionsSnapshot.forEach(doc => {
            totalQuestions++;
            if (doc.data().isAnswered) answeredQuestions++;
        });
        
        document.getElementById('publicQuestionCount').textContent = totalQuestions;
        document.getElementById('publicAnsweredCount').textContent = answeredQuestions;

        await loadPublicQuestions(username);

        document.getElementById('questionInput').value = '';
        document.getElementById('charCount').textContent = '0';
        
        setupCharCounter();
        
        // ‚úÖ Track active user
        trackActiveUser();
        
        // ‚úÖ Check my answered questions
        checkMyAnsweredQuestions();
        
        showPage('askPage');
    } catch (error) {
        console.error('Load ask page error:', error);
        showNotification('Bir hata olu≈ütu!');
    }
}

function setupCharCounter() {
    const input = document.getElementById('questionInput');
    const counter = document.getElementById('charCount');
    
    if (input && counter) {
        input.removeEventListener('input', updateCharCount);
        input.addEventListener('input', updateCharCount);
    }
}

function updateCharCount() {
    const input = document.getElementById('questionInput');
    const counter = document.getElementById('charCount');
    if (input && counter) {
        counter.textContent = input.value.length;
    }
}

// ============================================
// ‚úÖ LOAD PUBLIC QUESTIONS (WITH FOLLOW-UP)
// ============================================
async function loadPublicQuestions(username) {
    const container = document.getElementById('publicFeedContainer');
    const myAnonId = getOrCreateAnonId();
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <div style="width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px;"></div>
            Cevaplanan sorular y√ºkleniyor...
        </div>
    `;
    
    try {
        const snapshot = await db.collection('questions')
            .where('to', '==', username)
            .where('isAnswered', '==', true)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();

        const questions = [];
        snapshot.forEach(doc => {
            questions.push({ id: doc.id, ...doc.data() });
        });

        if (questions.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                    <div style="font-size: 48px; margin-bottom: 16px;">üí≠</div>
                    <h3 style="font-size: 18px; margin-bottom: 8px; color: var(--text);">Hen√ºz cevaplanan soru yok</h3>
                    <p style="font-size: 14px;">ƒ∞lk soruyu sen sor!</p>
                </div>
            `;
            return;
        }

        const questionsHTML = questions.map(q => {
            let timeAgo = 'Az √∂nce';
            try {
                if (q.answeredAt) {
                    const date = new Date(q.answeredAt.toDate());
                    timeAgo = getTimeAgo(date);
                } else if (q.createdAt) {
                    const date = new Date(q.createdAt.toDate());
                    timeAgo = getTimeAgo(date);
                }
            } catch (e) {
                console.log('Date error:', e);
            }
            
            // ‚úÖ Check if this is my question
            const isMyQuestion = q.anonId === myAnonId;
            
            return `
                <div class="question-card ${isMyQuestion ? 'my-question' : ''}" style="border-bottom: 1px solid var(--border); padding: 16px;">
                    <div style="display: flex; gap: 12px;">
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                            ${isMyQuestion ? 'üôã' : '‚ùì'}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                                <span style="font-weight: 700; font-size: 15px;">${isMyQuestion ? 'Sen' : 'Anonim'}</span>
                                <span style="color: var(--text-secondary); font-size: 15px;">@anonymous</span>
                                <span style="color: var(--text-secondary); font-size: 15px;">¬∑ ${timeAgo}</span>
                                ${isMyQuestion ? '<span style="background: var(--primary); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700;">SORUN</span>' : ''}
                            </div>
                            
                            <div style="font-size: 15px; line-height: 1.5; margin-bottom: 12px; word-wrap: break-word;">
                                ${escapeHtml(q.question)}
                            </div>
                            
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                                <div style="color: var(--text-secondary); font-size: 13px; font-weight: 600; margin-bottom: 8px;">
                                    üí¨ Cevap
                                </div>
                                <div style="font-size: 15px; line-height: 1.5; word-wrap: break-word; margin-bottom: 12px;">
                                    ${escapeHtml(q.answer || '')}
                                </div>
                                
                                ${isMyQuestion ? `
                                    <button 
                                        onclick="scrollToQuestionInput()"
                                        style="
                                            background: var(--primary);
                                            color: #fff;
                                            border: none;
                                            padding: 8px 16px;
                                            border-radius: 20px;
                                            font-size: 14px;
                                            font-weight: 600;
                                            cursor: pointer;
                                            display: inline-flex;
                                            align-items: center;
                                            gap: 6px;
                                        "
                                    >
                                        ‚ûï Tekrar Soru Sor
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = questionsHTML;
        
    } catch (error) {
        console.error('Load questions error:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</div>
                <h3 style="font-size: 18px; margin-bottom: 8px; color: var(--text);">Sorular y√ºklenemedi</h3>
                <p style="font-size: 14px;">${error.message}</p>
            </div>
        `;
    }
}

// ============================================
// ‚úÖ SEND QUESTION (WITH TRACKING)
// ============================================
async function sendQuestion() {
    const btn = document.getElementById('sendBtn');
    const text = document.getElementById('questionInput').value.trim();
    
    if (text.length < 3) {
        showNotification('Soru en az 3 karakter olmalƒ±!');
        return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('u');

    const anonId = getOrCreateAnonId();

    btn.disabled = true;
    btn.textContent = 'G√∂nderiliyor...';

    try {
        const userAgent = navigator.userAgent.toLowerCase();
        const referrer = document.referrer.toLowerCase();
        
        let source = 'üåê Web', sourceIcon = 'üåê', sourceName = 'Web';
        
        if (referrer.includes('twitter.com')) {
            source = 'üê¶ Twitter';
            sourceIcon = 'üê¶';
            sourceName = 'Twitter';
        }
        
        // ‚úÖ Save question with anonId
        const questionRef = await db.collection('questions').add({
            to: username,
            question: text,
            answer: null,
            isAnswered: false,
            source: source,
            sourceIcon: sourceIcon,
            sourceName: sourceName,
            anonId: anonId,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Save to localStorage
        let myQuestions = JSON.parse(localStorage.getItem('my_questions') || '{}');
        myQuestions[questionRef.id] = {
            to: username,
            askedAt: Date.now(),
            isAnswered: false
        };
        localStorage.setItem('my_questions', JSON.stringify(myQuestions));

        // ‚úÖ Increment Firebase stats
        incrementMessageCount();

        // OneSignal notification
        try {
            await fetch('/api/send-onesignal-notification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, questionText: text })
            });
        } catch (e) {
            console.log('Notification error:', e);
        }

        document.getElementById('questionInput').value = '';
        document.getElementById('charCount').textContent = '0';
        showNotification('Sorun g√∂nderildi! ‚úÖ');
        
        await loadPublicQuestions(username);
        
    } catch (error) {
        console.error('Send question error:', error);
        showNotification('Bir hata olu≈ütu!');
    } finally {
        btn.disabled = false;
        btn.textContent = 'G√∂nder';
    }
}

// ============================================
// ‚úÖ CHECK MY ANSWERED QUESTIONS
// ============================================
async function checkMyAnsweredQuestions() {
    const myQuestions = JSON.parse(localStorage.getItem('my_questions') || '{}');
    const questionIds = Object.keys(myQuestions);
    
    if (questionIds.length === 0) return;
    
    let newAnswers = 0;
    
    for (const qid of questionIds) {
        if (myQuestions[qid].isAnswered) continue;
        
        try {
            const doc = await db.collection('questions').doc(qid).get();
            if (doc.exists && doc.data().isAnswered) {
                myQuestions[qid].isAnswered = true;
                newAnswers++;
            }
        } catch (e) {
            console.log('Check error:', e);
        }
    }
    
    localStorage.setItem('my_questions', JSON.stringify(myQuestions));
    
    if (newAnswers > 0) {
        showNotification(`üéâ ${newAnswers} sorunuza cevap geldi!`);
    }
}

// ============================================
// SCROLL TO INPUT
// ============================================
function scrollToQuestionInput() {
    const input = document.getElementById('questionInput');
    if (input) {
        input.focus();
        input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        showNotification('üí≠ Yeni sorunuzu yazƒ±n!');
    }
}

// ============================================
// UTILS
// ============================================
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getTimeAgo(date) {
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Az √∂nce';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' dk';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' sa';
    if (seconds < 604800) return Math.floor(seconds / 86400) + ' g√ºn';
    
    return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
}

function loadDashboard() {
    showPage('dashboardPage');
}
</script>
</body>
</html>

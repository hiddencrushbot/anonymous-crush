<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Secretly Social üí≠</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #dc2626;
            --primary-hover: #b91c1c;
            --bg: #000;
            --bg-secondary: #16181c;
            --bg-tertiary: #1d1f23;
            --text: #e7e9ea;
            --text-secondary: #71767b;
            --border: #2f3336;
        }
        
        [data-theme="blue"] { --primary: #1d9bf0; --primary-hover: #1a8cd8; }
        [data-theme="green"] { --primary: #00ba7c; --primary-hover: #00a06a; }
        [data-theme="purple"] { --primary: #7856ff; --primary-hover: #6644ee; }
        [data-theme="orange"] { --primary: #ff7a00; --primary-hover: #e66d00; }
        [data-theme="pink"] { --primary: #f91880; --primary-hover: #e01070; }
        
        [data-mode="light"] {
            --bg: #ffffff;
            --bg-secondary: #f7f9f9;
            --bg-tertiary: #eff3f4;
            --text: #0f1419;
            --text-secondary: #536471;
            --border: #eff3f4;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        /* Header */
        .header {
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(12px);
        }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); cursor: pointer; }
        .header-actions { display: flex; gap: 8px; align-items: center; }
        .icon-btn {
            background: none;
            border: none;
            color: var(--text);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background 0.2s;
            position: relative;
        }
        .icon-btn:hover { background: var(--bg-tertiary); }
        .badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--primary);
            color: #fff;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 24px;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s;
            position: relative;
        }
        .nav-item span {
            font-size: 11px;
            font-weight: 600;
        }
        .nav-item:hover { background: var(--bg-tertiary); }
        .nav-item.active { color: var(--primary); }

        /* Profile Header */
        .profile-header {
            position: relative;
        }
        .profile-banner {
            height: 180px;
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            background-size: cover;
            background-position: center;
        }
        .profile-info {
            padding: 0 16px;
            margin-top: -60px;
            position: relative;
        }
        .profile-avatar-wrapper {
            position: relative;
            display: inline-block;
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--bg);
            background: var(--bg-secondary);
            object-fit: cover;
        }
        .avatar-placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--bg);
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            color: #fff;
        }
        .profile-actions {
            position: absolute;
            right: 16px;
            top: 70px;
            display: flex;
            gap: 8px;
        }
        .profile-name {
            font-size: 20px;
            font-weight: 800;
            margin-top: 12px;
        }
        .profile-handle {
            color: var(--text-secondary);
            font-size: 15px;
        }
        .profile-bio {
            margin-top: 12px;
            font-size: 15px;
            line-height: 1.4;
        }
        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .stat { font-size: 14px; cursor: pointer; }
        .stat:hover { text-decoration: underline; }
        .stat strong { color: var(--text); font-weight: 700; }
        .stat span { color: var(--text-secondary); }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { background: var(--primary-hover); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-outline:hover { background: var(--bg-tertiary); }
        .btn-sm { padding: 8px 16px; font-size: 14px; }
        .btn-full { width: 100%; }

        /* User List */
        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }
        .user-item:hover { background: var(--bg-secondary); }
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }
        .user-info { flex: 1; min-width: 0; }
        .user-name { font-weight: 700; font-size: 15px; }
        .user-handle { color: var(--text-secondary); font-size: 14px; }
        .mutual-badge {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            margin-top: 4px;
            display: inline-block;
        }

        /* Search Box */
        .search-box {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            position: sticky;
            top: 61px;
            z-index: 99;
        }
        .search-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 12px 20px;
            color: var(--text);
            font-size: 15px;
        }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .search-input::placeholder { color: var(--text-secondary); }

        /* Messages */
        .message-list {
            padding-bottom: 80px;
        }
        .message-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }
        .message-item:hover { background: var(--bg-secondary); }
        .message-item.unread {
            background: var(--bg-secondary);
        }
        .message-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 20px;
            flex-shrink: 0;
        }
        .message-content { flex: 1; min-width: 0; }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .message-name { font-weight: 700; font-size: 15px; }
        .message-time { color: var(--text-secondary); font-size: 13px; }
        .message-preview {
            color: var(--text-secondary);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-item.unread .message-preview {
            color: var(--text);
            font-weight: 600;
        }

        /* Chat View */
        .chat-header {
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .chat-messages {
            padding: 16px;
            padding-bottom: 80px;
            min-height: calc(100vh - 140px);
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .message-bubble.sent {
            background: var(--primary);
            color: #fff;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message-bubble.received {
            background: var(--bg-tertiary);
            color: var(--text);
            border-bottom-left-radius: 4px;
        }
        .message-text { font-size: 15px; line-height: 1.4; }
        .message-timestamp {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 4px;
        }
        .chat-input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .chat-input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 25px;
            padding: 12px 20px;
            color: var(--text);
            font-size: 15px;
            resize: none;
            max-height: 100px;
        }
        .chat-input:focus { outline: none; border-color: var(--primary); }

        /* Question Cards */
        .question-card {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        .question-card:hover { background: var(--bg-secondary); }
        .question-content {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 16px;
            border-left: 4px solid var(--primary);
            margin-bottom: 12px;
        }
        .question-text {
            font-size: 15px;
            line-height: 1.5;
        }
        .question-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 8px;
        }
        .answer-section { margin-top: 12px; }
        .answer-text {
            font-size: 15px;
            line-height: 1.5;
            padding: 12px 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state h3 { font-size: 18px; margin-bottom: 8px; color: var(--text); }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none !important; }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: #fff;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 1001;
            animation: slideUp 0.3s;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            position: sticky;
            top: 61px;
            z-index: 99;
        }
        .tab {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 16px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            position: relative;
            transition: background 0.2s;
        }
        .tab:hover { background: var(--bg-tertiary); }
        .tab.active { color: var(--text); }
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 4px;
            background: var(--primary);
            border-radius: 2px;
        }
    </style>
</head>
<body data-theme="red" data-mode="dark">
    <div id="notification" class="notification hidden"></div>

    <!-- Home/Profile Page -->
    <div id="homePage" class="hidden">
        <div class="header">
            <div class="logo" onclick="goHome()">Ask Secretly</div>
            <div class="header-actions">
                <button class="icon-btn" onclick="goToExplore()">üîç</button>
                <button class="icon-btn" id="messagesNotif" onclick="goToMessages()">
                    üí¨
                    <span class="badge hidden" id="messagesBadge">0</span>
                </button>
            </div>
        </div>
        
        <div class="container">
            <div class="profile-header">
                <div class="profile-banner" id="myBanner"></div>
                <div class="profile-info">
                    <div class="profile-avatar-wrapper">
                        <img id="myAvatar" class="profile-avatar hidden" src="" alt="">
                        <div id="myAvatarPlaceholder" class="avatar-placeholder">U</div>
                    </div>
                    <div class="profile-name" id="myName">Kullanƒ±cƒ±</div>
                    <div class="profile-handle" id="myHandle">@kullanici</div>
                    <div class="profile-stats">
                        <div class="stat" onclick="showFollowersList()">
                            <strong id="myFollowersCount">0</strong> <span>Takip√ßi</span>
                        </div>
                        <div class="stat" onclick="showFollowingList()">
                            <strong id="myFollowingCount">0</strong> <span>Takip</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active">Cevaplarƒ±m</button>
            </div>

            <div id="myAnsweredQuestions"></div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="goHome()">
                <div>üè†</div>
                <span>Ana Sayfa</span>
            </div>
            <div class="nav-item" onclick="goToExplore()">
                <div>üîç</div>
                <span>Ke≈üfet</span>
            </div>
            <div class="nav-item" onclick="goToMessages()">
                <div style="position: relative;">
                    üí¨
                    <span class="badge hidden" id="navMessagesBadge" style="top: -8px; right: -8px;">0</span>
                </div>
                <span>Mesajlar</span>
            </div>
        </div>
    </div>

    <!-- Public Profile Page -->
    <div id="profilePage" class="hidden">
        <div class="header">
            <button class="icon-btn" onclick="goBack()">‚Üê</button>
            <div class="logo">Profil</div>
            <div style="width: 36px;"></div>
        </div>
        
        <div class="container">
            <div class="profile-header">
                <div class="profile-banner" id="publicBanner"></div>
                <div class="profile-info">
                    <div class="profile-avatar-wrapper">
                        <img id="publicAvatar" class="profile-avatar hidden" src="" alt="">
                        <div id="publicAvatarPlaceholder" class="avatar-placeholder">U</div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-sm" id="followBtn" onclick="toggleFollow()">Takip Et</button>
                        <button class="btn btn-sm btn-outline" id="messageBtn" onclick="startChat()" style="display:none;">üí¨ Mesaj</button>
                    </div>
                    <div class="profile-name" id="publicName">Kullanƒ±cƒ±</div>
                    <div class="profile-handle" id="publicHandle">@kullanici</div>
                    <div class="profile-stats">
                        <div class="stat">
                            <strong id="publicFollowers">0</strong> <span>Takip√ßi</span>
                        </div>
                        <div class="stat">
                            <strong id="publicFollowing">0</strong> <span>Takip</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active">Cevaplar</button>
            </div>
            <div id="publicAnswers"></div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="goHome()">
                <div>üè†</div>
                <span>Ana Sayfa</span>
            </div>
            <div class="nav-item" onclick="goToExplore()">
                <div>üîç</div>
                <span>Ke≈üfet</span>
            </div>
            <div class="nav-item" onclick="goToMessages()">
                <div style="position: relative;">
                    üí¨
                    <span class="badge hidden" id="navMessagesBadge2" style="top: -8px; right: -8px;">0</span>
                </div>
                <span>Mesajlar</span>
            </div>
        </div>
    </div>

    <!-- Explore Page -->
    <div id="explorePage" class="hidden">
        <div class="header">
            <div class="logo">Ke≈üfet</div>
            <div class="header-actions">
                <button class="icon-btn" onclick="goHome()">üè†</button>
            </div>
        </div>

        <div class="search-box">
            <input type="text" class="search-input" id="exploreSearch" placeholder="Kullanƒ±cƒ± ara..." oninput="searchUsers()">
        </div>

        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="switchExploreTab('all')">T√ºm√º</button>
                <button class="tab" onclick="switchExploreTab('following')">Takip Ettiklerim</button>
                <button class="tab" onclick="switchExploreTab('followers')">Takip√ßilerim</button>
            </div>
            <div id="exploreList"></div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="goHome()">
                <div>üè†</div>
                <span>Ana Sayfa</span>
            </div>
            <div class="nav-item active" onclick="goToExplore()">
                <div>üîç</div>
                <span>Ke≈üfet</span>
            </div>
            <div class="nav-item" onclick="goToMessages()">
                <div style="position: relative;">
                    üí¨
                    <span class="badge hidden" id="navMessagesBadge3" style="top: -8px; right: -8px;">0</span>
                </div>
                <span>Mesajlar</span>
            </div>
        </div>
    </div>

    <!-- Messages Page -->
    <div id="messagesPage" class="hidden">
        <div class="header">
            <div class="logo">Mesajlar</div>
            <div class="header-actions">
                <button class="icon-btn" onclick="goHome()">üè†</button>
            </div>
        </div>

        <div class="container message-list" id="messagesList"></div>

        <div class="bottom-nav">
            <div class="nav-item" onclick="goHome()">
                <div>üè†</div>
                <span>Ana Sayfa</span>
            </div>
            <div class="nav-item" onclick="goToExplore()">
                <div>üîç</div>
                <span>Ke≈üfet</span>
            </div>
            <div class="nav-item active" onclick="goToMessages()">
                <div>üí¨</div>
                <span>Mesajlar</span>
            </div>
        </div>
    </div>

    <!-- Chat Page -->
    <div id="chatPage" class="hidden">
        <div class="chat-header">
            <button class="icon-btn" onclick="backToMessages()">‚Üê</button>
            <img id="chatAvatar" class="user-avatar" style="width: 40px; height: 40px; font-size: 16px;" src="" alt="">
            <div style="flex: 1;">
                <div class="user-name" id="chatName">Kullanƒ±cƒ±</div>
                <div class="user-handle" id="chatHandle">@kullanici</div>
            </div>
        </div>

        <div class="chat-messages" id="chatMessages"></div>

        <div class="chat-input-area">
            <textarea class="chat-input" id="chatInput" placeholder="Mesaj yaz..." rows="1" onkeydown="handleChatKeydown(event)"></textarea>
            <button class="btn btn-sm" onclick="sendMessage()">G√∂nder</button>
        </div>
    </div>

    <script>
        // Firebase
        let auth, db, storage;
        let currentUser = null;
        let currentUserData = null;
        let viewingUser = null;
        let currentChatUser = null;
        let chatListener = null;
        let exploreTab = 'all';
        let allUsers = [];

        function _0x(s) { return atob(s); }
        
        function initFirebase() {
            try {
                const _c = {
                    apiKey: _0x('QUl6YVN5RGFrSGJHQ2RPTXJST3R3RjY3R0pLLUJyandPeGplNkpv'),
                    authDomain: _0x('YXNrLWRpcmVjdGx5LmZpcmViYXNlYXBwLmNvbQ=='),
                    projectId: _0x('YXNrLWRpcmVjdGx5'),
                    storageBucket: _0x('YXNrLWRpcmVjdGx5LmZpcmViYXNlc3RvcmFnZS5hcHA='),
                    messagingSenderId: _0x('NzIzODY0NTg1NjQ3'),
                    appId: _0x('MTo3MjM4NjQ1ODU2NDc6d2ViOjliZGVmMGUzZjUwNGU2MmM2ODFiNWE=')
                };
                firebase.initializeApp(_c);
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                
                onAppReady();
            } catch (error) {
                console.error('Firebase init error:', error);
                showNotification('Baƒülantƒ± hatasƒ±! Sayfayƒ± yenileyin.');
            }
        }

        const savedTheme = localStorage.getItem('theme') || 'red';
        const savedMode = localStorage.getItem('mode') || 'dark';
        document.body.setAttribute('data-theme', savedTheme);
        document.body.setAttribute('data-mode', savedMode);
        
        async function onAppReady() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                await loadUserData();
                goHome();
            } else {
                showNotification('L√ºtfen ana sayfadan giri≈ü yapƒ±n!');
                setTimeout(() => {
                    window.location.href = 'ask-secretly.html';
                }, 2000);
            }
        }
        
        initFirebase();

        async function loadUserData() {
            if (!currentUser) return;
            
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (!userDoc.exists) {
                localStorage.removeItem('currentUser');
                window.location.href = 'ask-secretly.html';
                return;
            }
            currentUserData = userDoc.data();
            
            listenToMessages();
        }

        function showNotification(msg) {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 3000);
        }

        function showPage(pageId) {
            ['homePage', 'profilePage', 'explorePage', 'messagesPage', 'chatPage'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
        }

        // Navigation
        async function goHome() {
            showPage('homePage');
            document.getElementById('myName').textContent = currentUserData.displayName || currentUserData.username;
            document.getElementById('myHandle').textContent = '@' + currentUserData.username;
            
            if (currentUserData.photoURL) {
                document.getElementById('myAvatar').src = currentUserData.photoURL;
                document.getElementById('myAvatar').classList.remove('hidden');
                document.getElementById('myAvatarPlaceholder').classList.add('hidden');
            } else {
                document.getElementById('myAvatarPlaceholder').textContent = currentUserData.username[0].toUpperCase();
                document.getElementById('myAvatar').classList.add('hidden');
                document.getElementById('myAvatarPlaceholder').classList.remove('hidden');
            }

            if (currentUserData.bannerURL) {
                document.getElementById('myBanner').style.backgroundImage = `url(${currentUserData.bannerURL})`;
            }

            document.getElementById('myFollowersCount').textContent = currentUserData.followers?.length || 0;
            document.getElementById('myFollowingCount').textContent = currentUserData.following?.length || 0;

            await loadMyAnsweredQuestions();
        }

        async function loadMyAnsweredQuestions() {
            const container = document.getElementById('myAnsweredQuestions');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Y√ºkleniyor...</div>';

            try {
                const snapshot = await db.collection('questions')
                    .where('to', '==', currentUser.uid)
                    .where('isAnswered', '==', true)
                    .orderBy('answeredAt', 'desc')
                    .limit(20)
                    .get();

                const questions = [];
                snapshot.forEach(doc => questions.push({ id: doc.id, ...doc.data() }));

                if (questions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üí≠</div>
                            <h3>Hen√ºz cevap yok</h3>
                            <p>Gelen sorularƒ±nƒ± cevapla!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = questions.map(q => {
                    const date = q.answeredAt ? new Date(q.answeredAt.toDate()).toLocaleDateString('tr-TR') : '';
                    return `
                        <div class="question-card">
                            <div class="question-content">
                                <div class="question-text">${escapeHtml(q.question)}</div>
                                <div class="question-meta">
                                    <span>üïê ${date}</span>
                                </div>
                            </div>
                            <div class="answer-section">
                                <div class="answer-text">${escapeHtml(q.answer)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Load questions error:', error);
                container.innerHTML = '<div class="empty-state"><h3>Bir hata olu≈ütu</h3></div>';
            }
        }

        async function goToProfile(username) {
            if (username === currentUser.uid) {
                goHome();
                return;
            }

            showPage('profilePage');
            
            const userDoc = await db.collection('users').doc(username).get();
            if (!userDoc.exists) {
                showNotification('Kullanƒ±cƒ± bulunamadƒ±!');
                goHome();
                return;
            }

            viewingUser = userDoc.data();
            
            document.getElementById('publicName').textContent = viewingUser.displayName || viewingUser.username;
            document.getElementById('publicHandle').textContent = '@' + viewingUser.username;
            
            if (viewingUser.photoURL) {
                document.getElementById('publicAvatar').src = viewingUser.photoURL;
                document.getElementById('publicAvatar').classList.remove('hidden');
                document.getElementById('publicAvatarPlaceholder').classList.add('hidden');
            } else {
                document.getElementById('publicAvatarPlaceholder').textContent = viewingUser.username[0].toUpperCase();
                document.getElementById('publicAvatar').classList.add('hidden');
                document.getElementById('publicAvatarPlaceholder').classList.remove('hidden');
            }

            if (viewingUser.bannerURL) {
                document.getElementById('publicBanner').style.backgroundImage = `url(${viewingUser.bannerURL})`;
            } else {
                document.getElementById('publicBanner').style.backgroundImage = '';
            }

            document.getElementById('publicFollowers').textContent = viewingUser.followers?.length || 0;
            document.getElementById('publicFollowing').textContent = viewingUser.following?.length || 0;

            const following = currentUserData.following || [];
            const isFollowing = following.includes(username);
            document.getElementById('followBtn').textContent = isFollowing ? 'Takiptesin' : 'Takip Et';

            const followers = currentUserData.followers || [];
            const isMutual = isFollowing && followers.includes(username);
            document.getElementById('messageBtn').style.display = isMutual ? 'inline-flex' : 'none';

            await loadPublicAnswers(username);
        }

        async function loadPublicAnswers(username) {
            const container = document.getElementById('publicAnswers');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Y√ºkleniyor...</div>';

            try {
                const snapshot = await db.collection('questions')
                    .where('to', '==', username)
                    .where('isAnswered', '==', true)
                    .orderBy('answeredAt', 'desc')
                    .limit(20)
                    .get();

                const questions = [];
                snapshot.forEach(doc => questions.push({ id: doc.id, ...doc.data() }));

                if (questions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üí≠</div>
                            <h3>Hen√ºz cevap yok</h3>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = questions.map(q => {
                    const date = q.answeredAt ? new Date(q.answeredAt.toDate()).toLocaleDateString('tr-TR') : '';
                    return `
                        <div class="question-card">
                            <div class="question-content">
                                <div class="question-text">${escapeHtml(q.question)}</div>
                                <div class="question-meta">
                                    <span>üïê ${date}</span>
                                </div>
                            </div>
                            <div class="answer-section">
                                <div class="answer-text">${escapeHtml(q.answer)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Load public answers error:', error);
                container.innerHTML = '<div class="empty-state"><h3>Bir hata olu≈ütu</h3></div>';
            }
        }

        async function toggleFollow() {
            if (!viewingUser) return;

            const targetUsername = viewingUser.username;
            const myRef = db.collection('users').doc(currentUser.uid);
            const targetRef = db.collection('users').doc(targetUsername);

            try {
                const myDoc = await myRef.get();
                const following = myDoc.data().following || [];
                
                if (following.includes(targetUsername)) {
                    await myRef.update({ following: firebase.firestore.FieldValue.arrayRemove(targetUsername) });
                    await targetRef.update({ followers: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
                    document.getElementById('followBtn').textContent = 'Takip Et';
                    document.getElementById('messageBtn').style.display = 'none';
                    showNotification('Takipten √ßƒ±kƒ±ldƒ±');
                    currentUserData.following = following.filter(u => u !== targetUsername);
                } else {
                    await myRef.update({ following: firebase.firestore.FieldValue.arrayUnion(targetUsername) });
                    await targetRef.update({ followers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
                    document.getElementById('followBtn').textContent = 'Takiptesin';
                    
                    const targetDoc = await targetRef.get();
                    const targetFollowing = targetDoc.data().following || [];
                    if (targetFollowing.includes(currentUser.uid)) {
                        document.getElementById('messageBtn').style.display = 'inline-flex';
                    }
                    
                    showNotification('Takip edildi! ‚úÖ');
                    currentUserData.following = [...following, targetUsername];
                }
            } catch (error) {
                console.error('Follow error:', error);
                showNotification('Bir hata olu≈ütu!');
            }
        }

        async function goToExplore() {
            showPage('explorePage');
            exploreTab = 'all';
            document.querySelectorAll('#explorePage .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#explorePage .tab')[0].classList.add('active');
            document.getElementById('exploreSearch').value = '';
            await loadExploreUsers();
        }

        async function switchExploreTab(tab) {
            exploreTab = tab;
            document.querySelectorAll('#explorePage .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            await loadExploreUsers();
        }

        async function loadExploreUsers() {
            const container = document.getElementById('exploreList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Y√ºkleniyor...</div>';

            try {
                const snapshot = await db.collection('users').limit(100).get();
                allUsers = [];
                snapshot.forEach(doc => {
                    if (doc.id !== currentUser.uid) {
                        allUsers.push({ username: doc.id, ...doc.data() });
                    }
                });

                displayUsers(allUsers);
            } catch (error) {
                console.error('Load users error:', error);
                container.innerHTML = '<div class="empty-state"><h3>Bir hata olu≈ütu</h3></div>';
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('exploreList');
            
            let filteredUsers = users;
            
            if (exploreTab === 'following') {
                const following = currentUserData.following || [];
                filteredUsers = users.filter(u => following.includes(u.username));
            } else if (exploreTab === 'followers') {
                const followers = currentUserData.followers || [];
                filteredUsers = users.filter(u => followers.includes(u.username));
            }

            if (filteredUsers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <h3>Kullanƒ±cƒ± bulunamadƒ±</h3>
                    </div>
                `;
                return;
            }

            const following = currentUserData.following || [];
            const followers = currentUserData.followers || [];

            container.innerHTML = filteredUsers.map(u => {
                const isFollowing = following.includes(u.username);
                const isFollower = followers.includes(u.username);
                const isMutual = isFollowing && isFollower;
                
                return `
                    <div class="user-item" onclick="goToProfile('${u.username}')">
                        ${u.photoURL ? 
                            `<img src="${u.photoURL}" class="user-avatar" alt="">` :
                            `<div class="user-avatar">${u.username[0].toUpperCase()}</div>`
                        }
                        <div class="user-info">
                            <div class="user-name">${escapeHtml(u.displayName || u.username)}</div>
                            <div class="user-handle">@${u.username}</div>
                            ${isMutual ? '<span class="mutual-badge">üí¨ Kar≈üƒ±lƒ±klƒ± takip</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchUsers() {
            const query = document.getElementById('exploreSearch').value.toLowerCase().trim();
            
            if (!query) {
                displayUsers(allUsers);
                return;
            }

            const filtered = allUsers.filter(u => 
                u.username.toLowerCase().includes(query) || 
                (u.displayName && u.displayName.toLowerCase().includes(query))
            );

            displayUsers(filtered);
        }

        async function goToMessages() {
            showPage('messagesPage');
            await loadMessagesList();
        }

        async function loadMessagesList() {
            const container = document.getElementById('messagesList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Y√ºkleniyor...</div>';

            try {
                const following = currentUserData.following || [];
                const followers = currentUserData.followers || [];
                const mutualUsers = following.filter(u => followers.includes(u));

                if (mutualUsers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üí¨</div>
                            <h3>Hen√ºz mesaj yok</h3>
                            <p>Kar≈üƒ±lƒ±klƒ± takip ettiƒüin ki≈üilerle mesajla≈üabilirsin!</p>
                        </div>
                    `;
                    return;
                }

                const chats = [];
                for (const username of mutualUsers) {
                    const userDoc = await db.collection('users').doc(username).get();
                    const userData = userDoc.data();
                    
                    const chatId = [currentUser.uid, username].sort().join('_');
                    const messagesSnapshot = await db.collection('chats').doc(chatId).collection('messages')
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get();
                    
                    let lastMessage = null;
                    let unread = 0;
                    
                    if (!messagesSnapshot.empty) {
                        const msgData = messagesSnapshot.docs[0].data();
                        lastMessage = msgData;
                        
                        const unreadSnapshot = await db.collection('chats').doc(chatId).collection('messages')
                            .where('from', '==', username)
                            .where('read', '==', false)
                            .get();
                        unread = unreadSnapshot.size;
                    }
                    
                    chats.push({ username, userData, lastMessage, unread });
                }

                chats.sort((a, b) => {
                    if (!a.lastMessage) return 1;
                    if (!b.lastMessage) return -1;
                    return b.lastMessage.timestamp.toMillis() - a.lastMessage.timestamp.toMillis();
                });

                if (chats.length === 0 || !chats.some(c => c.lastMessage)) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üí¨</div>
                            <h3>Hen√ºz mesaj yok</h3>
                            <p>Kar≈üƒ±lƒ±klƒ± takip ettiƒüin ki≈üilerle mesajla≈ü!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = chats.map(chat => {
                    if (!chat.lastMessage) return '';
                    
                    const time = new Date(chat.lastMessage.timestamp.toDate());
                    const now = new Date();
                    const diffMs = now - time;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    let timeStr;
                    if (diffMins < 1) timeStr = '≈ûimdi';
                    else if (diffMins < 60) timeStr = diffMins + 'd';
                    else if (diffHours < 24) timeStr = diffHours + 's';
                    else if (diffDays < 7) timeStr = diffDays + 'g';
                    else timeStr = time.toLocaleDateString('tr-TR');
                    
                    return `
                        <div class="message-item ${chat.unread > 0 ? 'unread' : ''}" onclick="openChat('${chat.username}')">
                            ${chat.userData.photoURL ? 
                                `<img src="${chat.userData.photoURL}" class="message-avatar" alt="">` :
                                `<div class="message-avatar">${chat.username[0].toUpperCase()}</div>`
                            }
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-name">${escapeHtml(chat.userData.displayName || chat.username)}</span>
                                    <span class="message-time">${timeStr}</span>
                                </div>
                                <div class="message-preview">${escapeHtml(chat.lastMessage.text)}</div>
                            </div>
                            ${chat.unread > 0 ? `<span class="badge">${chat.unread}</span>` : ''}
                        </div>
                    `;
                }).join('');

                const totalUnread = chats.reduce((sum, c) => sum + c.unread, 0);
                updateMessageBadges(totalUnread);

            } catch (error) {
                console.error('Load messages error:', error);
                container.innerHTML = '<div class="empty-state"><h3>Bir hata olu≈ütu</h3></div>';
            }
        }

        function updateMessageBadges(count) {
            const badges = [
                document.getElementById('messagesBadge'),
                document.getElementById('navMessagesBadge'),
                document.getElementById('navMessagesBadge2'),
                document.getElementById('navMessagesBadge3')
            ];
            
            badges.forEach(badge => {
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
        }

        async function listenToMessages() {
            const following = currentUserData.following || [];
            const followers = currentUserData.followers || [];
            const mutualUsers = following.filter(u => followers.includes(u));
            
            if (mutualUsers.length === 0) return;
            
            mutualUsers.forEach(username => {
                const chatId = [currentUser.uid, username].sort().join('_');
                db.collection('chats').doc(chatId).collection('messages')
                    .where('from', '==', username)
                    .where('read', '==', false)
                    .onSnapshot(() => {
                        if (document.getElementById('messagesPage').classList.contains('hidden')) {
                            loadMessagesList();
                        }
                    });
            });
        }

        async function startChat() {
            if (!viewingUser) return;
            openChat(viewingUser.username);
        }

        async function openChat(username) {
            currentChatUser = username;
            showPage('chatPage');
            
            const userDoc = await db.collection('users').doc(username).get();
            const userData = userDoc.data();
            
            document.getElementById('chatName').textContent = userData.displayName || username;
            document.getElementById('chatHandle').textContent = '@' + username;
            
            if (userData.photoURL) {
                document.getElementById('chatAvatar').innerHTML = `<img src="${userData.photoURL}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" alt="">`;
            } else {
                document.getElementById('chatAvatar').textContent = username[0].toUpperCase();
            }

            await loadChatMessages(username);
            markMessagesAsRead(username);
        }

        async function loadChatMessages(username) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Y√ºkleniyor...</div>';

            const chatId = [currentUser.uid, username].sort().join('_');
            
            if (chatListener) chatListener();
            
            chatListener = db.collection('chats').doc(chatId).collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const messages = [];
                    snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                    
                    if (messages.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">üí¨</div>
                                <h3>ƒ∞lk mesajƒ± g√∂nder!</h3>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = messages.map(msg => {
                        const isSent = msg.from === currentUser.uid;
                        const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : '';
                        
                        return `
                            <div style="display: flex; justify-content: ${isSent ? 'flex-end' : 'flex-start'};">
                                <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                                    <div class="message-text">${escapeHtml(msg.text)}</div>
                                    <div class="message-timestamp">${time}</div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    container.scrollTop = container.scrollHeight;
                    markMessagesAsRead(username);
                });
        }

        async function markMessagesAsRead(username) {
            const chatId = [currentUser.uid, username].sort().join('_');
            
            const unreadSnapshot = await db.collection('chats').doc(chatId).collection('messages')
                .where('from', '==', username)
                .where('read', '==', false)
                .get();
            
            const batch = db.batch();
            unreadSnapshot.forEach(doc => {
                batch.update(doc.ref, { read: true });
            });
            
            if (!unreadSnapshot.empty) {
                await batch.commit();
                await loadMessagesList();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || !currentChatUser) return;
            
            const chatId = [currentUser.uid, currentChatUser].sort().join('_');
            
            try {
                await db.collection('chats').doc(chatId).collection('messages').add({
                    from: currentUser.uid,
                    to: currentChatUser,
                    text: text,
                    read: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                input.value = '';
                input.style.height = 'auto';
            } catch (error) {
                console.error('Send message error:', error);
                showNotification('Mesaj g√∂nderilemedi!');
            }
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function backToMessages() {
            if (chatListener) {
                chatListener();
                chatListener = null;
            }
            currentChatUser = null;
            goToMessages();
        }

        function goBack() {
            goHome();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function showFollowersList() {
            showNotification('Takip√ßiler listesi yakƒ±nda!');
        }

        async function showFollowingList() {
            showNotification('Takip edilenler listesi yakƒ±nda!');
        }

        document.getElementById('chatInput')?.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    </script>
</body>
</html>